<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CMX Command Center ‚Äî AKT Global</title>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
// Verify CDN libraries loaded ‚Äî show helpful message if blocked by org policy
window.addEventListener('DOMContentLoaded', function() {
  var missing = [];
  if (typeof PptxGenJS === 'undefined') missing.push('PptxGenJS (PPTX generation)');
  if (typeof XLSX === 'undefined') missing.push('SheetJS (XLSX generation)');
  if (missing.length > 0) {
    var banner = document.createElement('div');
    banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;background:#CC3300;color:#fff;padding:12px 20px;font-size:13px;text-align:center;font-family:sans-serif;';
    banner.innerHTML = '‚ö†Ô∏è External libraries blocked by your organization\'s security policy: <strong>' + missing.join(', ') + '</strong>. The Intelligence tab will work for analysis, but artifact generation (PPTX/XLSX) requires these libraries. Ask your IT admin to whitelist <code>cdn.jsdelivr.net</code>, or use the standalone version locally.';
    document.body.prepend(banner);
  }
});
</script>
<style>
:root {
  --navy: #2D2015;
  --orange: #F9A13A;
  --cream: #FEF0DB;
  --off-white: #F7F5F2;
  --gray: #737373;
  --light-gray: #E0E0E0;
  --border: #E0D8CE;
  --ok: #468A4B;
  --error: #CC3300;
  --warn: #E8911A;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--off-white);
  color: #333;
}
header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--navy);
  padding: 0 40px;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 4px solid var(--orange);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.logo {
  display: flex;
  align-items: center;
  gap: 16px;
}
.logo-mark { font-weight: 900; font-size: 24px; color: var(--orange); font-family: 'Arial Black', Arial; }
.logo-text { font-size: 15px; font-weight: 600; color: #fff; }
.logo-text .sub { color: var(--orange); font-weight: 700; }
.hdr-metrics {
  display: flex;
  gap: 28px;
  align-items: center;
  font-size: 12px;
  color: rgba(255,255,255,0.7);
}
.hdr-metric-item { display: flex; flex-direction: column; align-items: flex-end; }
.hdr-metric-val { font-weight: 700; color: #fff; font-size: 14px; }
.tabs-row {
  display: flex;
  gap: 2px;
  border-bottom: 1px solid var(--border);
  background: var(--off-white);
  padding: 0 40px;
}
.tab {
  padding: 14px 20px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  color: var(--gray);
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
}
.tab:hover { color: var(--navy); }
.tab.active { color: var(--navy); border-bottom-color: var(--orange); }
main {
  max-width: 1200px;
  margin: 0 auto;
  padding: 40px 40px 80px;
}
h2 {
  font-family: 'Georgia', serif;
  font-size: 32px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 8px;
}
.subtitle {
  font-size: 14px;
  color: var(--gray);
  margin-bottom: 28px;
  line-height: 1.6;
}
.progress-ring-container {
  position: relative;
  width: 180px;
  height: 180px;
  margin: 0 auto;
}
svg.progress-ring { transform: rotate(-90deg); }
.progress-ring-circle {
  fill: none;
  stroke: var(--off-white);
  stroke-width: 8;
}
.progress-ring-circle.active {
  fill: none;
  stroke: var(--orange);
  stroke-width: 8;
  stroke-dasharray: 565;
  stroke-dashoffset: var(--offset, 565);
  transition: stroke-dashoffset 0.6s ease;
}
.progress-ring-label {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}
.progress-ring-val { font-size: 36px; font-weight: 700; color: var(--navy); }
.progress-ring-txt { font-size: 12px; color: var(--gray); margin-top: 2px; }
.card {
  background: #fff;
  border-radius: 10px;
  border: 1px solid var(--border);
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}
.card h3 {
  font-size: 16px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 16px;
}
.card-label {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--orange);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.card-label::before {
  content: '';
  width: 3px;
  height: 12px;
  background: var(--orange);
  border-radius: 1px;
}
.hero-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 28px;
}
.hero-card {
  background: #fff;
  border-radius: 10px;
  border: 1px solid var(--border);
  padding: 20px;
  text-align: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}
.hero-card .val {
  font-size: 42px;
  font-weight: 700;
  color: var(--navy);
  line-height: 1;
}
.hero-card .lbl {
  font-size: 12px;
  color: var(--gray);
  margin-top: 8px;
}
.hero-card.amber .val { color: #D97706; }
.hero-card.green .val { color: var(--ok); }
.hero-card.red .val { color: var(--error); }
.hero-card.blue .val { color: #3366CC; }
.quick-actions {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 14px;
  margin-bottom: 28px;
}
.action-card {
  background: #fff;
  border-radius: 10px;
  border: 1px solid var(--border);
  padding: 18px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}
.action-card:hover {
  border-color: var(--orange);
  box-shadow: 0 4px 12px rgba(249,161,58,0.2);
  transform: translateY(-2px);
}
.action-card .icon { font-size: 32px; margin-bottom: 8px; }
.action-card .title { font-size: 13px; font-weight: 700; color: var(--navy); }
.action-card .desc { font-size: 11px; color: var(--gray); margin-top: 4px; }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
.pipeline-stage {
  background: #fff;
  border-radius: 10px;
  border: 1px solid var(--border);
  padding: 16px;
  margin-bottom: 12px;
}
.pipeline-stage .code {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--orange);
  margin-bottom: 6px;
}
.pipeline-stage .name {
  font-size: 14px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 8px;
}
.pipeline-stage .meta {
  font-size: 12px;
  color: var(--gray);
  display: flex;
  gap: 12px;
  margin-bottom: 8px;
}
.pipeline-stage .status-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
}
.status-workshop-delivered { background: #e8f5e9; color: var(--ok); }
.status-artifacts-generated { background: var(--cream); color: var(--warn); }
.status-analysis-complete { background: #e0f2f1; color: #006462; }
.intel-card {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 18px;
  margin-bottom: 14px;
  border-left: 4px solid var(--orange);
}
.intel-card h4 {
  font-size: 14px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 4px;
}
.intel-card .dec-id {
  font-size: 10px;
  font-weight: 700;
  color: var(--orange);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 6px;
}
.intel-card .desc {
  font-size: 13px;
  color: #333;
  line-height: 1.5;
  margin-bottom: 10px;
}
.consensus-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 8px 0;
  font-size: 12px;
}
.consensus-bar .label { width: 100px; flex-shrink: 0; color: var(--gray); }
.consensus-bar .track {
  flex: 1;
  height: 16px;
  background: var(--off-white);
  border-radius: 8px;
  overflow: hidden;
}
.consensus-bar .fill {
  height: 100%;
  background: var(--ok);
  display: flex;
  align-items: center;
  padding-left: 6px;
  font-size: 10px;
  font-weight: 600;
  color: #fff;
  border-radius: 8px;
}
.consensus-bar .pct { width: 40px; flex-shrink: 0; text-align: right; font-weight: 600; color: var(--navy); }
.risk-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  margin-right: 6px;
  margin-bottom: 6px;
}
.risk-high { background: #ffebee; color: #c62828; }
.risk-medium { background: var(--cream); color: var(--warn); }
.risk-low { background: #e8f5e9; color: var(--ok); }
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
thead {
  background: var(--off-white);
  border-bottom: 2px solid var(--border);
}
th {
  padding: 12px;
  text-align: left;
  font-weight: 700;
  color: var(--navy);
}
td {
  padding: 12px;
  border-bottom: 1px solid var(--border);
}
tbody tr:hover { background: var(--cream); }
.badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
}
.badge-exec { background: #e8f5e9; color: var(--ok); }
.badge-ops { background: var(--cream); color: var(--warn); }
.badge-tech { background: #e0f2f1; color: #006462; }
.badge-regional { background: #e0e7ff; color: #3366CC; }
.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: var(--orange);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 10px 20px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(249,161,58,0.3);
}
.btn:hover { background: var(--warn); transform: translateY(-1px); }
.btn-secondary {
  background: #fff;
  color: var(--navy);
  border: 1px solid var(--border);
  box-shadow: none;
}
.btn-secondary:hover { background: var(--off-white); }
.btn-large {
  padding: 14px 32px;
  font-size: 15px;
}
.hidden { display: none !important; }
.mt-4 { margin-top: 40px; }
.mb-4 { margin-bottom: 40px; }
.panel { display: none; }
.panel.active { display: block; }

/* Intelligence Engine Embedded Styles */
.ie-steps {
  display: flex;
  gap: 0;
  margin-bottom: 28px;
  background: #fff;
  border-radius: 10px;
  border: 1px solid var(--border);
  overflow: hidden;
}
.ie-step {
  flex: 1;
  padding: 14px 18px;
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: 0.15s;
  border-right: 1px solid var(--border);
  position: relative;
}
.ie-step:last-child { border-right: none; }
.ie-step:hover { background: var(--cream); }
.ie-step.ie-act { background: var(--cream); }
.ie-step.ie-done { background: #e8f5e9; }
.ie-step .ie-num {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--border);
  color: var(--gray);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
  flex-shrink: 0;
  transition: 0.2s;
}
.ie-step.ie-act .ie-num {
  background: var(--orange);
  color: #fff;
}
.ie-step.ie-done .ie-num {
  background: var(--ok);
  color: #fff;
}
.ie-step .ie-stxt {
  font-size: 12px;
  font-weight: 600;
  color: var(--gray);
}
.ie-step.ie-act .ie-stxt { color: #333; }
.ie-step.ie-done .ie-stxt { color: var(--ok); }
.ie-panel { display: none; }
.ie-panel.ie-act { display: block; }

.ie-drop {
  border: 2px dashed var(--border);
  border-radius: 10px;
  padding: 40px 20px;
  text-align: center;
  cursor: pointer;
  transition: 0.2s;
  background: var(--off-white);
}
.ie-drop:hover, .ie-drop.ie-over {
  border-color: var(--orange);
  background: var(--cream);
}
.ie-drop h3 { font-size: 16px; color: var(--navy); margin-bottom: 6px; }
.ie-drop p { font-size: 13px; color: var(--gray); }
.ie-drop .ie-icon { font-size: 36px; margin-bottom: 10px; }

.ie-form {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
  margin-bottom: 14px;
}
.ie-form3 {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 14px;
  margin-bottom: 14px;
}
.ie-fg {
  display: flex;
  flex-direction: column;
  gap: 5px;
  margin-bottom: 12px;
}
label { font-size: 13px; font-weight: 600; }
input, select, textarea {
  padding: 9px 12px;
  border: 1.5px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
  font-family: inherit;
  color: #333;
  background: #fff;
  outline: none;
  width: 100%;
  transition: 0.15s;
}
input:focus, select:focus, textarea:focus { border-color: var(--orange); }
textarea { resize: vertical; min-height: 100px; line-height: 1.5; }

.ie-acts {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.ie-stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}
.ie-stat {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px;
  text-align: center;
}
.ie-stat .ie-val { font-size: 24px; font-weight: 700; color: var(--orange); }
.ie-stat .ie-lbl { font-size: 11px; color: var(--gray); margin-top: 2px; }

@media(max-width: 768px) {
  header { padding: 0 20px; }
  .hero-stats { grid-template-columns: 1fr; }
  .quick-actions { grid-template-columns: 1fr 1fr; }
  .grid-2, .grid-3 { grid-template-columns: 1fr; }
  main { padding: 20px 20px 60px; }
  .ie-form, .ie-form3, .ie-stats { grid-template-columns: 1fr; }
  .ie-steps { flex-direction: column; }
}
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-mark">akt</div>
    <div class="logo-text">CMX <span class="sub">Command Center</span></div>
  </div>
  <div class="hdr-metrics">
    <div class="hdr-metric-item">
      <span>Engagement</span>
      <span class="hdr-metric-val" id="hdrEngagement">‚Äî</span>
    </div>
    <div class="hdr-metric-item">
      <span>Completion</span>
      <span class="hdr-metric-val" id="hdrCompletion">‚Äî</span>
    </div>
    <div class="hdr-metric-item">
      <span>Last Updated</span>
      <span class="hdr-metric-val" id="hdrUpdated">‚Äî</span>
    </div>
  </div>
</header>

<div class="tabs-row">
  <div class="tab active" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</div>
  <div class="tab" data-tab="pipeline" onclick="switchTab('pipeline')">Pipeline</div>
  <div class="tab" data-tab="intelligence" onclick="switchTab('intelligence')">Intelligence</div>
  <div class="tab" data-tab="deckengine" onclick="switchTab('deckengine')">Deck Engine</div>
  <div class="tab" data-tab="progress" onclick="switchTab('progress')">Progress</div>
  <div class="tab" data-tab="assets" onclick="switchTab('assets')">Assets</div>
  <div class="tab" data-tab="timeline" onclick="switchTab('timeline')">Timeline</div>
</div>

<main>

<!-- DASHBOARD TAB -->
<div class="panel active" id="dashboard">
  <h2>CMX Program Dashboard</h2>
  <p class="subtitle">Nextera Energy ‚Äî Grid Modernization Transformation Program (GMTP) ‚Äî Real-time intelligence from 12 stakeholders</p>

  <div class="grid-2">
    <div>
      <div class="card">
        <div class="card-label">Overall Completion Status</div>
        <div class="progress-ring-container">
          <svg class="progress-ring" width="180" height="180" viewBox="0 0 190 190">
            <circle class="progress-ring-circle" cx="95" cy="95" r="90" stroke-width="8" />
            <circle class="progress-ring-circle active" cx="95" cy="95" r="90" stroke-width="8" style="--offset: 0;" />
          </svg>
          <div class="progress-ring-label">
            <div class="progress-ring-val" id="progressVal">87%</div>
            <div class="progress-ring-txt">Finalized</div>
          </div>
        </div>
      </div>
    </div>
    <div>
      <div class="hero-stats">
        <div class="hero-card amber">
          <div class="val">68%</div>
          <div class="lbl">Overall Readiness</div>
        </div>
        <div class="hero-card green">
          <div class="val">72%</div>
          <div class="lbl">Avg Consensus</div>
        </div>
        <div class="hero-card red">
          <div class="val">4</div>
          <div class="lbl">Risk Signals</div>
        </div>
      </div>
      <div class="hero-stats" style="margin-bottom: 0;">
        <div class="hero-card blue">
          <div class="val">9</div>
          <div class="lbl">Open Points</div>
        </div>
        <div class="hero-card">
          <div class="val" style="color: var(--gray);">12</div>
          <div class="lbl">Respondents</div>
        </div>
        <div class="hero-card">
          <div class="val" style="color: var(--gray);">8</div>
          <div class="lbl">Decisions</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Quick Actions</h3>
    <div class="quick-actions">
      <div class="action-card" onclick="switchTab('intelligence')">
        <div class="icon">üß†</div>
        <div class="title">Intelligence Engine</div>
        <div class="desc">Analyze responses</div>
      </div>
      <div class="action-card" onclick="window.location.href='CMX Pre-Workshop Questionnaire.html'">
        <div class="icon">üìã</div>
        <div class="title">Questionnaire</div>
        <div class="desc">WS1 Survey (33Q)</div>
      </div>
      <div class="action-card" onclick="window.location.href='CMX Demo Guide.html'">
        <div class="icon">üìö</div>
        <div class="title">Demo Guide</div>
        <div class="desc">Complete overview</div>
      </div>
      <div class="action-card" onclick="generateDeckWS1()">
        <div class="icon">üìä</div>
        <div class="title">Generate Deck</div>
        <div class="desc">WS1 PPTX</div>
      </div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-label">Role Distribution</div>
      <div id="roleDist"></div>
    </div>
    <div class="card">
      <div class="card-label">Key Metrics by Role</div>
      <table>
        <thead>
          <tr><th>Role</th><th>Count</th><th>Avg Readiness</th><th>Consensus</th></tr>
        </thead>
        <tbody id="roleMetrics"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- PIPELINE TAB -->
<div class="panel" id="pipeline">
  <h2>Program Pipeline</h2>
  <p class="subtitle">All 6 stages of the CMX Foundations Program ‚Äî from initial workshops through decision finalizations</p>

  <div class="grid-2">
    <div>
      <div class="card">
        <div class="card-label">Workshops</div>
        <div id="stagesWorkshops"></div>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-label">Decision Workshops</div>
        <div id="stagesDecisions"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-label">All Stages (Timeline View)</div>
    <div id="allStages"></div>
  </div>
</div>

<!-- INTELLIGENCE TAB WITH EMBEDDED INTELLIGENCE ENGINE -->
<div class="panel" id="intelligence">
  <h2>Stakeholder Intelligence</h2>
  <p class="subtitle">Deep-dive analysis with 4-step Intelligence Engine wizard: Configure ‚Üí Import Data ‚Üí Intelligence ‚Üí Generate</p>

  <!-- Intelligence Engine Steps -->
  <div class="ie-steps" id="ie-steps">
    <div class="ie-step ie-act" data-p="ie-p1" onclick="ieGoStep('ie-p1')"><div class="ie-num">1</div><div class="ie-stxt">Configure</div></div>
    <div class="ie-step" data-p="ie-p2" onclick="ieGoStep('ie-p2')"><div class="ie-num">2</div><div class="ie-stxt">Import Data</div></div>
    <div class="ie-step" data-p="ie-p3" onclick="ieGoStep('ie-p3')"><div class="ie-num">3</div><div class="ie-stxt">Intelligence</div></div>
    <div class="ie-step" data-p="ie-p4" onclick="ieGoStep('ie-p4')"><div class="ie-num">4</div><div class="ie-stxt">Generate</div></div>
  </div>

  <!-- PANEL 1: CONFIGURE -->
  <div class="ie-panel ie-act" id="ie-p1">
    <div class="card">
      <div class="card-label">Client Context</div>
      <div class="ie-form">
        <div class="ie-fg"><label>Client Name</label><input id="ieCName" placeholder="e.g. Nextera Energy"/></div>
        <div class="ie-fg"><label>Program Name</label><input id="ieCProg" placeholder="e.g. Grid Modernization Transformation Program"/></div>
      </div>
      <div class="ie-form3">
        <div class="ie-fg"><label>Workshop Date</label><input type="date" id="ieWDate"/></div>
        <div class="ie-fg"><label>AKT Lead</label><input id="ieALead" placeholder="e.g. James Whitford"/></div>
        <div class="ie-fg"><label>Duration</label><input id="ieWDur" placeholder="e.g. 2.5 hours"/></div>
      </div>
    </div>
    <div class="card">
      <div class="card-label">Additional Briefing Context <span style="font-weight: 400; color: var(--gray);">(optional ‚Äî paste any extra notes)</span></div>
      <div class="ie-fg">
        <textarea id="ieExtraNotes" rows="6" placeholder="Paste any briefing material, political dynamics, watch-outs, or context not captured in the Qualtrics survey..."></textarea>
      </div>
    </div>
    <div class="ie-acts">
      <button class="btn" onclick="ieGoStep('ie-p2')">Next: Import Qualtrics Data ‚Üí</button>
    </div>
  </div>

  <!-- PANEL 2: IMPORT -->
  <div class="ie-panel" id="ie-p2">
    <div class="card">
      <div class="card-label">Import Qualtrics Response Export</div>
      <div class="ie-drop" id="ieDropZone" onclick="document.getElementById('ieCsvFile').click()">
        <div class="ie-icon">üìä</div>
        <h3>Drop Qualtrics CSV export here</h3>
        <p>Or click to browse. Accepts .csv files exported from Qualtrics.</p>
        <input type="file" id="ieCsvFile" accept=".csv" style="display:none" onchange="ieHandleFile(event)"/>
      </div>
      <div id="ieImportStatus" style="margin-top:14px"></div>
    </div>
    <div class="card" id="ieDataPreview" style="display:none">
      <div class="card-label">Data Preview</div>
      <div class="ie-stats" id="ieRespStats"></div>
      <div id="ieRoleBreakdown"></div>
    </div>
    <div class="card">
      <div class="card-label">Or: Use Demo Data (Nextera Energy)</div>
      <p style="font-size:13px;color:var(--gray);margin-bottom:12px">Load simulated responses based on the Nextera Energy briefing to test the full pipeline.</p>
      <button class="btn btn-secondary" onclick="ieLoadDemoData()">Load Nextera Demo Data (12 respondents)</button>
    </div>
    <div class="ie-acts">
      <button class="btn btn-secondary" onclick="ieGoStep('ie-p1')">‚Üê Back</button>
      <button class="btn" id="ieBtnAnalyze" onclick="ieRunAnalysis()" disabled>Analyze Responses ‚Üí</button>
    </div>
  </div>

  <!-- PANEL 3: INTELLIGENCE -->
  <div class="ie-panel" id="ie-p3">
    <div class="ie-stats" id="ieIntStats"></div>
    <div id="ieDecisionAnalysis"></div>
    <div class="ie-acts">
      <button class="btn btn-secondary" onclick="ieGoStep('ie-p2')">‚Üê Back</button>
      <button class="btn" onclick="ieGoStep('ie-p4')">Next: Generate Artifacts ‚Üí</button>
    </div>
  </div>

  <!-- PANEL 4: GENERATE -->
  <div class="ie-panel" id="ie-p4">
    <div class="card">
      <div class="card-label">Generate Workshop Artifacts</div>
      <p class="subtitle" style="margin-bottom:20px">All artifacts are pre-populated with stakeholder intelligence from the Qualtrics responses. Click each to generate and download.</p>
      <div class="grid-3">
        <div class="action-card" style="cursor: pointer;" onclick="ieGenerateDeck()">
          <div class="icon">üìä</div>
          <div class="title">Workshop Deck</div>
          <p style="font-size: 12px; color: var(--gray);">Pre-populated PPTX with governance charts, concern heatmaps, regional maps, and decision frameworks.</p>
          <span style="display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 10px; font-weight: 600; margin-top: 8px; background: var(--cream); color: var(--warn);">PPTX</span>
        </div>
        <div class="action-card" style="cursor: pointer;" onclick="ieGenerateTracker()">
          <div class="icon">üìã</div>
          <div class="title">Open Points Tracker</div>
          <p style="font-size: 12px; color: var(--gray);">XLSX tracker seeded with open points extracted from responses, with owners and priorities.</p>
          <span style="display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 10px; font-weight: 600; margin-top: 8px; background: #e8f5e9; color: var(--ok);">XLSX</span>
        </div>
        <div class="action-card" style="cursor: pointer;" onclick="ieGenerateBriefing()">
          <div class="icon">üìù</div>
          <div class="title">Facilitator Briefing</div>
          <p style="font-size: 12px; color: var(--gray);">Per-decision intelligence summary: consensus, divergence, risk signals, and recommended positions.</p>
          <span style="display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 10px; font-weight: 600; margin-top: 8px; background: #e0f2f1; color: #006462;">HTML ‚Üí Print</span>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-label">Generate All at Once</div>
      <div class="ie-acts">
        <button class="btn" style="font-size:16px;padding:14px 32px; background: var(--ok);" onmouseover="this.style.background='#3a7a3f'" onmouseout="this.style.background='var(--ok)'" onclick="ieGenerateAll()">‚ö° Generate All 3 Artifacts</button>
      </div>
    </div>
    <div class="ie-acts">
      <button class="btn btn-secondary" onclick="ieGoStep('ie-p3')">‚Üê Back to Intelligence</button>
    </div>
  </div>

  <!-- Command Center Dashboard Intelligence (always shown below wizard) -->
  <hr style="margin: 40px 0; border: none; border-top: 1px solid var(--border);">
  <h3 style="margin-bottom: 20px; color: var(--navy);">Dashboard Intelligence (WS1 Command Center Data)</h3>

  <div class="card">
    <div class="card-label">Intelligence Summary</div>
    <div class="grid-3" id="intelSummary"></div>
  </div>

  <div class="card">
    <div class="card-label">Decision Analysis (D1-D8)</div>
    <div id="decisionAnalysisCards"></div>
  </div>

  <div class="card">
    <div class="card-label">Risk Dashboard</div>
    <div id="riskDashboard"></div>
  </div>

  <div class="card">
    <div class="card-label">Stakeholder Readiness & Watch List</div>
    <table>
      <thead>
        <tr>
          <th>Stakeholder</th>
          <th>Role</th>
          <th>Department</th>
          <th>Readiness</th>
          <th>Primary Concern</th>
          <th>Flag</th>
        </tr>
      </thead>
      <tbody id="stakeholderTable"></tbody>
    </table>
  </div>
</div>

<!-- DECK ENGINE TAB -->
<div class="panel" id="deckengine">
  <h2>Deck Engine ‚Äî PPTX Generation</h2>
  <p class="subtitle">Generate professional AKT-branded workshop decks pre-populated with stakeholder intelligence</p>

  <div class="grid-2">
    <div class="card">
      <div class="card-label">WS1: Governance & Decision Framework</div>
      <p style="font-size: 13px; color: #333; margin-bottom: 14px; line-height: 1.5;">7-slide deck with stakeholder overview, risk dashboard, consensus analysis, and decision deep-dives. Pre-populated with Nextera data.</p>
      <button class="btn btn-large" onclick="generateDeckWS1()">Generate WS1 PPTX</button>
    </div>
    <div class="card">
      <div class="card-label">WS2: Stakeholder Mapping & Communications</div>
      <p style="font-size: 13px; color: #333; margin-bottom: 14px; line-height: 1.5;">Impacted groups analysis, communication matrix, cascade planning. Design coming in next release.</p>
      <button class="btn btn-secondary btn-large" disabled>Coming Soon</button>
    </div>
  </div>

  <div class="card">
    <div class="card-label">Deck Generation Status</div>
    <div id="deckStatus"></div>
  </div>
</div>

<!-- PROGRESS TAB -->
<div class="panel" id="progress">
  <h2>Finalization Checklists</h2>
  <p class="subtitle">Track completion across all 6 stages of the CMX program</p>

  <div class="grid-2">
    <div class="card">
      <div class="card-label">WS1: Governance & Decision Framework</div>
      <div id="checklistWS1"></div>
    </div>
    <div class="card">
      <div class="card-label">WS2: Stakeholder Mapping & Communications</div>
      <div id="checklistWS2"></div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-label">WS3: Survey Content & Design</div>
      <div id="checklistWS3"></div>
    </div>
    <div class="card">
      <div class="card-label">WS4: Platform & Metadata Architecture</div>
      <div id="checklistWS4"></div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-label">DW1: E2E Process Decisions</div>
      <div id="checklistDW1"></div>
    </div>
    <div class="card">
      <div class="card-label">DW2: Dashboards & Ticketing Decisions</div>
      <div id="checklistDW2"></div>
    </div>
  </div>
</div>

<!-- ASSETS TAB -->
<div class="panel" id="assets">
  <h2>Program Assets & Downloads</h2>
  <p class="subtitle">All artifacts, questionnaires, session outputs, and supporting materials</p>

  <div class="card">
    <div class="card-label">Primary Artifacts</div>
    <div class="grid-3">
      <a href="CMX Intelligence Engine.html" style="text-decoration: none;">
        <div class="action-card">
          <div class="icon">üß†</div>
          <div class="title">Intelligence Engine</div>
          <div class="desc">Analysis platform</div>
        </div>
      </a>
      <a href="CMX Pre-Workshop Questionnaire.html" style="text-decoration: none;">
        <div class="action-card">
          <div class="icon">üìã</div>
          <div class="title">WS1 Questionnaire</div>
          <div class="desc">33 questions, 12 responses</div>
        </div>
      </a>
      <a href="CMX Demo Guide.html" style="text-decoration: none;">
        <div class="action-card">
          <div class="icon">üìö</div>
          <div class="title">Demo Guide</div>
          <div class="desc">Full methodology walkthrough</div>
        </div>
      </a>
    </div>
  </div>

  <div class="card">
    <div class="card-label">Workshop Outputs</div>
    <div class="grid-3">
      <a href="CMX DW1 Session Outputs.html" style="text-decoration: none;">
        <div class="action-card">
          <div class="icon">üìä</div>
          <div class="title">DW1 Session Outputs</div>
          <div class="desc">E2E Process & Intake</div>
        </div>
      </a>
      <a href="CMX DW2 Session Outputs.html" style="text-decoration: none;">
        <div class="action-card">
          <div class="icon">üìä</div>
          <div class="title">DW2 Session Outputs</div>
          <div class="desc">Dashboards & Ticketing</div>
        </div>
      </a>
      <div class="action-card" onclick="alert('WS2-4 outputs coming after workshop delivery')">
        <div class="icon">üìÇ</div>
        <div class="title">WS2-4 Outputs</div>
        <div class="desc">Coming post-workshops</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-label">Supporting Documentation</div>
    <div class="grid-3">
      <a href="CMX Program Hub.html" style="text-decoration: none;">
        <div class="action-card">
          <div class="icon">üè†</div>
          <div class="title">Program Hub</div>
          <div class="desc">Central navigation</div>
        </div>
      </a>
      <a href="CMX PPT Engine - Architecture.html" style="text-decoration: none;">
        <div class="action-card">
          <div class="icon">‚öôÔ∏è</div>
          <div class="title">PPT Engine</div>
          <div class="desc">PPTX generation docs</div>
        </div>
      </a>
      <a href="Qualtrics Test Export - CMX WS1.csv" style="text-decoration: none;">
        <div class="action-card">
          <div class="icon">üìä</div>
          <div class="title">Qualtrics Test Export</div>
          <div class="desc">Sample CSV data</div>
        </div>
      </a>
    </div>
  </div>

  <div class="card">
    <div class="card-label">Downloadable Files</div>
    <table>
      <thead>
        <tr><th>File Name</th><th>Type</th><th>Description</th><th>Action</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>CMX Intelligence Engine - Senior Team Introduction.pptx</td>
          <td>PPTX</td>
          <td>Executive briefing deck (45 min presentation)</td>
          <td><a href="CMX Intelligence Engine - Senior Team Introduction.pptx" download style="color: var(--orange); text-decoration: none; font-weight: 600;">Download</a></td>
        </tr>
        <tr>
          <td>CMX WS1 Workshop Deck - Mockup.pptx</td>
          <td>PPTX</td>
          <td>Original workshop mockup (reference)</td>
          <td><a href="CMX WS1 Workshop Deck - Mockup.pptx" download style="color: var(--orange); text-decoration: none; font-weight: 600;">Download</a></td>
        </tr>
        <tr>
          <td>CMX WS1 Pre-Workshop Questionnaire - Qualtrics Spec.xlsx</td>
          <td>XLSX</td>
          <td>Qualtrics question specification (advanced)</td>
          <td><a href="CMX WS1 Pre-Workshop Questionnaire - Qualtrics Spec.xlsx" download style="color: var(--orange); text-decoration: none; font-weight: 600;">Download</a></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- TIMELINE TAB -->
<div class="panel" id="timeline">
  <h2>Program Timeline</h2>
  <p class="subtitle">Sequencing of workshops, decision workshops, and key milestones</p>

  <div class="card">
    <div class="card-label">Phase 1: Governance & Design</div>
    <div id="timelinePhase1"></div>
  </div>

  <div class="card">
    <div class="card-label">Phase 2: Platform & Architecture</div>
    <div id="timelinePhase2"></div>
  </div>

  <div class="card">
    <div class="card-label">Phase 3: Finalization & Go-Live</div>
    <div id="timelinePhase3"></div>
  </div>
</div>

</main>

<script>
// ============================================================================
// CMX COMMAND CENTER + INTELLIGENCE ENGINE INTEGRATION
// Real-time intelligence + PPTX generation + 4-step Intelligence Engine wizard
// ============================================================================

const STATE = {
  responses: [],
  analysis: null,
  currentTab: 'dashboard',
  ieResponses: [],
  ieAnalysis: null,
  ieLead: null,
  ieClientName: '',
  ieWorkshopDate: '',
  ieCurrentStep: 'ie-p1'
};

// ============================================================================
// COMMAND CENTER: DEMO DATA - Exact Nextera Energy stakeholder responses
// ============================================================================
const DEMO_DATA = [
  {
    role: 'Executive',
    name: 'Patricia Chen',
    email: 'patricia.chen@nextera.com',
    department: 'Office of the Chief Transformation Officer',
    Q5: 'Hybrid (Global framework + Regional execution)',
    Q6: 3, Q7: 4, Q8: 2, Q9: 4,
    Q10: ['Survey completion rate', 'Speed of insights', 'Data accuracy'],
    Q11: 'Moderate (10-20 fields)',
    Q12: 'Quarterly deep dives',
    Q13: 5,
    Q14: ['Executive summary (1-page)', 'KPI dashboard (real-time)', 'Risk heatmap'],
    Q15: 'Escalations should go to CTO office within 48 hours. We need clear decision trees.',
    Q16: 4,
    Q31: 'Workday extract mechanism TBD',
    Q32: 'Scope creep ‚Äî starting with CMX and expanding to include culture, benefits satisfaction',
    Q33: 'Excited about data-driven approach to governance decisions.'
  },
  {
    role: 'Executive',
    name: 'Michael Rothstein',
    email: 'michael.rothstein@nextera.com',
    department: 'Human Resources',
    Q5: 'Centralized (Global decision-making)',
    Q6: 2, Q7: 3, Q8: 3, Q9: 5,
    Q10: ['Survey completion rate', 'Stakeholder engagement', 'Data accuracy'],
    Q11: 'Detailed (20+ fields)',
    Q12: 'Monthly pulse surveys',
    Q13: 4,
    Q14: ['Executive summary (1-page)', 'Trend analysis'],
    Q15: 'HR should own escalations. Policy violations escalate to me directly.',
    Q16: 3,
    Q31: 'SMS provider selection pending',
    Q32: 'Will this fragment our employee engagement data across too many platforms?',
    Q33: 'Need integration with Glint blackout calendar.'
  },
  {
    role: 'Operational',
    name: 'Angela Ramirez',
    email: 'angela.ramirez@nextera.com',
    department: 'Operations ‚Äî Florida Power & Light',
    Q5: 'Hybrid (Global framework + Regional execution)',
    Q6: 3, Q7: 4, Q8: 3, Q9: 4,
    Q10: ['Survey completion rate', 'Action closure rate', 'Stakeholder engagement'],
    Q11: 'Moderate (10-20 fields)',
    Q12: 'Monthly pulse surveys',
    Q17: 4,
    Q18: '2,200 field workers across Florida Gulf Coast, predominantly in substations and distribution centers. ~60% without email access.',
    Q19: ['Spanish'],
    Q20: 2,
    Q21: 'Using Glint for culture surveys and pulse checks.',
    Q31: 'Glint blackout alignment needed (Dec 15 - Jan 15, all surveys frozen)',
    Q32: 'Ensuring field workers can respond via SMS/QR codes, not just web.',
    Q33: 'FPL is the largest region. Need Spanish version urgently.'
  },
  {
    role: 'Operational',
    name: 'David Park',
    email: 'david.park@nextera.com',
    department: 'Enterprise Transformation Office',
    Q5: 'Hybrid (Global framework + Regional execution)',
    Q6: 4, Q7: 3, Q8: 4, Q9: 3,
    Q10: ['Action closure rate', 'Data accuracy'],
    Q11: 'Simple (5-10 fields)',
    Q12: 'Quarterly deep dives',
    Q17: 3,
    Q18: 'Distributed across all 14 regions with 70% salaried (email access) and 30% hourly/field.',
    Q19: ['Spanish', 'English only'],
    Q20: 1,
    Q21: 'Internal feedback system (email-based). Will retire after CMX launch.',
    Q31: 'Contact frequency rules: max 1 survey per quarter per employee',
    Q32: 'Change fatigue ‚Äî three major initiatives running simultaneously',
    Q33: 'Important to keep intake simple to maximize field worker participation.'
  },
  {
    role: 'Operational',
    name: 'Jennifer Walsh',
    email: 'jennifer.walsh@nextera.com',
    department: 'Enterprise Transformation Office',
    Q5: 'Decentralized (Regional autonomy)',
    Q6: 2, Q7: 5, Q8: 2, Q9: 4,
    Q10: ['Survey completion rate', 'Stakeholder engagement'],
    Q11: 'Simple (5-10 fields)',
    Q12: 'Event-driven (at milestones)',
    Q17: 2,
    Q18: 'Field workers concentrated in Florida (35%), Carolinas (25%), Illinois (20%), other regions (20%).',
    Q19: ['Spanish'],
    Q20: 3,
    Q21: 'Stand-alone survey sent via email to managers for cascade.',
    Q31: 'Need manager escalation workflow for open themes',
    Q32: 'Regions have different maturity and readiness. One-size-fits-all won\'t work.',
    Q33: 'Regional leads need autonomy in timing and communication.'
  },
  {
    role: 'Operational',
    name: 'Thomas Jackson',
    email: 'thomas.jackson@nextera.com',
    department: 'Program Management Office',
    Q5: 'Centralized (Global decision-making)',
    Q6: 3, Q7: 4, Q8: 3, Q9: 4,
    Q10: ['Survey completion rate', 'Speed of insights'],
    Q11: 'Moderate (10-20 fields)',
    Q12: 'Monthly pulse surveys',
    Q17: 3,
    Q18: 'Mix of corporate office, service centers, and distributed field operations. ~4,000 field workers without reliable email.',
    Q19: ['Spanish'],
    Q20: 2,
    Q21: 'Qualtrics XM community feedback (limited structure).',
    Q31: 'Division Admin access rights definition pending',
    Q32: 'Getting field workers to respond reliably is the biggest blocker.',
    Q33: 'SMS/QR approach is critical. Email-only won\'t reach our people.'
  },
  {
    role: 'Technical',
    name: 'Vikram Gupta',
    email: 'vikram.gupta@nextera.com',
    department: 'Information Technology',
    Q5: 'Hybrid (Global framework + Regional execution)',
    Q6: 4, Q7: 2, Q8: 4, Q9: 5,
    Q10: ['Data accuracy'],
    Q11: 'Detailed (20+ fields)',
    Q12: 'Monthly pulse surveys',
    Q22: 'Yes, via file transfer',
    Q23: 'Yes (Azure AD)',
    Q24: '24-month data retention policy. Data purged via automated script quarterly.',
    Q25: 'SAP S/4HANA backend. Qualtrics API supported but rate-limited to 1,000 calls/day. Workday integration pending API access approval.',
    Q26: 4,
    Q31: 'Workday API access approval (Legal team sign-off)',
    Q32: 'Data governance and compliance. NERC CIP requirements mean survey data might be classified as operational data.',
    Q33: 'Contact Directory quality is key blocker. Need master data cleanup before go-live.'
  },
  {
    role: 'Technical',
    name: 'Sophia Martinez',
    email: 'sophia.martinez@nextera.com',
    department: 'Qualtrics Platform Administration',
    Q5: 'Decentralized (Regional autonomy)',
    Q6: 3, Q7: 3, Q8: 3, Q9: 4,
    Q10: ['Speed of insights', 'Data accuracy'],
    Q11: 'Moderate (10-20 fields)',
    Q12: 'Quarterly deep dives',
    Q22: 'Yes, via API',
    Q23: 'Yes (Azure AD)',
    Q24: 'Compliance holds everything for 12 months. Historical data archived to cold storage.',
    Q25: 'API constraints: webhook latency up to 5 minutes. Batch exports only, no real-time streaming.',
    Q26: 3,
    Q31: 'SMS provider vendor selection TBD (Twilio vs MessageBird)',
    Q32: 'Duplicate respondent IDs across regions. Need deduplication logic.',
    Q33: 'Existing Qualtrics infrastructure can handle the load but metadata enrichment is manual.'
  },
  {
    role: 'Technical',
    name: 'Robert Kim',
    email: 'robert.kim@nextera.com',
    department: 'Data & Analytics',
    Q5: 'Hybrid (Global framework + Regional execution)',
    Q6: 2, Q7: 2, Q8: 2, Q9: 5,
    Q10: ['Data accuracy'],
    Q11: 'Detailed (20+ fields)',
    Q12: 'Quarterly deep dives',
    Q22: 'Not yet',
    Q23: 'Yes (Other)',
    Q24: 'Governed by Legal ‚Äî unclear exactly. Probably 12-24 months.',
    Q25: 'No real-time BI integration. Manual exports to Tableau. No API yet.',
    Q26: 2,
    Q31: 'Real-time dashboard integration not planned for MVP',
    Q32: 'Metadata quality is atrocious. Region codes inconsistent, employee IDs change.',
    Q33: 'Data engineering team is understaffed. Need to keep CMX simple or accept manual cleanup overhead.'
  },
  {
    role: 'Regional',
    name: 'Linda Santos',
    email: 'linda.santos@nextera.com',
    department: 'Human Resources ‚Äî Florida Power & Light',
    Q5: 'Decentralized (Regional autonomy)',
    Q6: 3, Q7: 5, Q8: 2, Q9: 4,
    Q10: ['Survey completion rate', 'Stakeholder engagement'],
    Q11: 'Simple (5-10 fields)',
    Q12: 'Monthly pulse surveys',
    Q27: 4,
    Q28: 'FPL is mature and stable. Field workers are organized. Just need good communication cadence and clear role definitions.',
    Q29: 4,
    Q30: 'Spanish-speaking communities dominant. Union workforce ‚Äî need careful change messaging. Established employee networks.',
    Q31: 'None that I see ‚Äî FPL is ready.',
    Q32: 'Making sure union leadership is involved early.',
    Q33: 'FPL can be the pilot region if needed. We have capacity.'
  },
  {
    role: 'Regional',
    name: 'Nathan Powell',
    email: 'nathan.powell@nextera.com',
    department: 'Human Resources ‚Äî NextEra Energy Resources (NEER)',
    Q5: 'Hybrid (Global framework + Regional execution)',
    Q6: 2, Q7: 4, Q8: 3, Q9: 4,
    Q10: ['Speed of insights', 'Data accuracy'],
    Q11: 'Moderate (10-20 fields)',
    Q12: 'Quarterly deep dives',
    Q27: 2,
    Q28: 'NEER is younger and more distributed (wind farms, solar sites). Different maturity levels across sub-regions.',
    Q29: 2,
    Q30: 'Fast-growing workforce. High turnover in some sub-regions. Remote/transient workers.',
    Q31: 'Need flexible launch timeline for different NEER sub-regions',
    Q32: 'Talent retention is unstable ‚Äî survey fatigue could drive more departures.',
    Q33: 'Consider phased rollout: NEER corporate first, then field operations.'
  },
  {
    role: 'Regional',
    name: 'Sarah Chen',
    email: 'sarah.chen@nextera.com',
    department: 'Human Resources ‚Äî Corporate Services Regions (Midwest + East)',
    Q5: 'Hybrid (Global framework + Regional execution)',
    Q6: 4, Q7: 3, Q8: 4, Q9: 3,
    Q10: ['Survey completion rate', 'Action closure rate'],
    Q11: 'Moderate (10-20 fields)',
    Q12: 'Monthly pulse surveys',
    Q27: 3,
    Q28: 'Corporate offices are smaller but strategic (legal, finance, HR, CTO). Need executive visibility but not field complexity.',
    Q29: 3,
    Q30: 'Midwest and East region leads work virtually and need async communication. Time zone considerations (CST, EST, even PST for some teams).',
    Q31: 'None.',
    Q32: 'Ensuring corporate surveys don\'t duplicate what Glint is already doing.',
    Q33: 'Happy to align with global cadence once roles/process are clear.'
  }
];

// Program Stages
const STAGES = [
  { id: 'ws1', code: 'WS1', name: 'Governance & Decision Framework', type: 'workshop', questions: 33, respondents: 12, status: 'workshop-delivered' },
  { id: 'ws2', code: 'WS2', name: 'Stakeholder Mapping & Communications', type: 'workshop', questions: 25, respondents: 10, status: 'artifacts-generated' },
  { id: 'ws3', code: 'WS3', name: 'Survey Content & Design', type: 'workshop', questions: 28, respondents: 10, status: 'artifacts-generated' },
  { id: 'ws4', code: 'WS4', name: 'Platform & Metadata Architecture', type: 'workshop', questions: 26, respondents: 8, status: 'analysis-complete' },
  { id: 'dw1', code: 'DW1', name: 'E2E Process Decisions', type: 'decision', decisions: 12, status: 'workshop-delivered' },
  { id: 'dw2', code: 'DW2', name: 'Dashboards & Ticketing Decisions', type: 'decision', decisions: 10, status: 'artifacts-generated' }
];

// ============================================================================
// COMMAND CENTER: ANALYSIS ENGINE
// ============================================================================

function runAnalysis() {
  const responses = STATE.responses;

  const d5Responses = responses
    .filter(r => r.Q5)
    .map(r => ({ role: r.role, answer: r.Q5 }));

  const d5Consensus = computeConsensusForDecision(d5Responses, 'D5');
  const roleMetrics = computeRoleMetrics(responses);
  const readiness = computeReadinessScore(responses);
  const openPoints = extractOpenPoints(responses);
  const risks = identifyRisks(responses);

  STATE.analysis = {
    d5Consensus,
    roleMetrics,
    readiness,
    openPoints,
    risks,
    lastUpdated: new Date().toLocaleString()
  };

  updateUI();
}

function computeConsensusForDecision(responses, decisionId) {
  if (responses.length === 0) return { consensus: 0, majority: '', alignment: {} };

  const counts = {};
  responses.forEach(r => {
    const ans = r.answer.substring(0, 20);
    counts[ans] = (counts[ans] || 0) + 1;
  });

  const total = responses.length;
  const maxCount = Math.max(...Object.values(counts));
  const consensus = Math.round((maxCount / total) * 100);
  const majority = Object.entries(counts).reduce((a, b) => counts[b[0]] > counts[a[0]] ? b[0] : a[0]);

  return { consensus, majority, alignment: counts };
}

function computeRoleMetrics(responses) {
  const roles = {};

  responses.forEach(r => {
    if (!roles[r.role]) {
      roles[r.role] = { count: 0, readinessScores: [], consensusScores: [] };
    }
    roles[r.role].count++;

    const readiness = (r.Q13 || 0) + (r.Q16 || 0) + (r.Q26 || 0);
    roles[r.role].readinessScores.push(readiness);
  });

  const result = {};
  Object.entries(roles).forEach(([role, data]) => {
    const avgReadiness = data.readinessScores.length > 0
      ? Math.round((data.readinessScores.reduce((a, b) => a + b, 0) / data.readinessScores.length) / 3 * 100)
      : 0;
    result[role] = { count: data.count, avgReadiness };
  });

  return result;
}

function computeReadinessScore(responses) {
  const scores = [];
  responses.forEach(r => {
    const q13 = r.Q13 || 0;
    const q16 = r.Q16 || 0;
    const q26 = r.Q26 || 0;
    const total = (q13 + q16 + q26) / 3;
    scores.push(total);
  });

  const avg = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
  return Math.round((avg / 5) * 100);
}

function extractOpenPoints(responses) {
  const points = [];

  responses.forEach(r => {
    if (r.Q31) points.push({ category: 'Blocker', text: r.Q31, owner: r.name, priority: 'High' });
    if (r.Q32) points.push({ category: 'Risk', text: r.Q32, owner: r.name, priority: 'Medium' });
    if (r.Q33) points.push({ category: 'Opportunity', text: r.Q33, owner: r.name, priority: 'Low' });
  });

  return points;
}

function identifyRisks(responses) {
  const risks = [];

  const readiness = computeReadinessScore(responses);
  if (readiness < 70) {
    risks.push({
      category: 'Capacity',
      severity: 'High',
      title: 'Overall Program Readiness Below 70%',
      description: `Current readiness score is ${readiness}%. Teams may struggle with implementation pace.`
    });
  }

  const decentralizedCount = responses.filter(r => r.Q5 && r.Q5.includes('Decentralized')).length;
  if (decentralizedCount > 4) {
    risks.push({
      category: 'Alignment',
      severity: 'High',
      title: 'Strong Decentralization Preference',
      description: `${decentralizedCount} stakeholders prefer regional autonomy. May conflict with centralized governance model.`
    });
  }

  const fieldWorkerConcerns = responses.filter(r =>
    (r.Q32 && r.Q32.includes('field worker')) ||
    (r.Q33 && r.Q33.includes('field'))
  ).length;
  if (fieldWorkerConcerns > 3) {
    risks.push({
      category: 'Adoption',
      severity: 'High',
      title: 'Field Worker Accessibility',
      description: `${fieldWorkerConcerns} stakeholders flagged field worker participation as critical. SMS/QR code approach essential.`
    });
  }

  const dataRisks = responses.filter(r =>
    (r.Q32 && r.Q32.includes('Data')) ||
    (r.Q33 && r.Q33.includes('data'))
  ).length;
  if (dataRisks > 2) {
    risks.push({
      category: 'Data',
      severity: 'Medium',
      title: 'Data Quality & Integration Blockers',
      description: `${dataRisks} stakeholders flagged data governance, NERC CIP, and integration concerns.`
    });
  }

  return risks;
}

// ============================================================================
// COMMAND CENTER: UI RENDERING
// ============================================================================

function switchTab(tabName) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

  document.getElementById(tabName).classList.add('active');
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

  STATE.currentTab = tabName;
}

function updateUI() {
  if (!STATE.analysis) return;

  document.getElementById('hdrEngagement').textContent = '12 / 12';
  document.getElementById('hdrCompletion').textContent = '100%';
  document.getElementById('hdrUpdated').textContent = new Date().toLocaleTimeString();

  renderRoleDistribution();
  renderRoleMetricsTable();
  renderPipeline();
  renderIntelligenceSummary();
  renderDecisionAnalysis();
  renderRiskDashboard();
  renderStakeholderTable();
  renderChecklists();
  renderTimeline();
}

function renderRoleDistribution() {
  const metrics = STATE.analysis.roleMetrics;
  let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">';

  Object.entries(metrics).forEach(([role, data]) => {
    const color = role === 'Executive' ? '#468A4B' : role === 'Operational' ? '#E8911A' : role === 'Technical' ? '#006462' : '#3366CC';
    html += `
      <div style="display: flex; align-items: center; gap: 10px;">
        <div style="width: 12px; height: 12px; background: ${color}; border-radius: 50%;"></div>
        <div style="flex: 1; font-size: 13px;">
          <strong>${role}</strong><br/>
          <span style="color: #999; font-size: 11px;">${data.count} respondents</span>
        </div>
        <div style="font-size: 16px; font-weight: 700; color: ${color};">${data.count}</div>
      </div>
    `;
  });

  html += '</div>';
  document.getElementById('roleDist').innerHTML = html;
}

function renderRoleMetricsTable() {
  const metrics = STATE.analysis.roleMetrics;
  let html = '';

  Object.entries(metrics).forEach(([role, data]) => {
    const badgeClass = role === 'Executive' ? 'badge-exec' : role === 'Operational' ? 'badge-ops' : role === 'Technical' ? 'badge-tech' : 'badge-regional';
    html += `
      <tr>
        <td><span class="badge ${badgeClass}">${role}</span></td>
        <td>${data.count}</td>
        <td><strong>${data.avgReadiness}%</strong></td>
        <td>72%</td>
      </tr>
    `;
  });

  document.getElementById('roleMetrics').innerHTML = html;
}

function renderPipeline() {
  let wsHtml = '', dwHtml = '', allHtml = '';

  STAGES.forEach(stage => {
    const statusClass = `status-${stage.status.replace(/-/g, '-')}`;
    const stageHtml = `
      <div class="pipeline-stage">
        <div class="code">${stage.code}</div>
        <div class="name">${stage.name}</div>
        <div class="meta">
          <span>${stage.type === 'workshop' ? stage.questions + ' Questions' : stage.decisions + ' Decisions'}</span>
          <span>${stage.respondents || stage.decisions || 'TBD'}</span>
        </div>
        <span class="status-badge ${statusClass}">${stage.status.replace(/-/g, ' ')}</span>
      </div>
    `;

    allHtml += stageHtml;

    if (stage.type === 'workshop') {
      wsHtml += stageHtml;
    } else {
      dwHtml += stageHtml;
    }
  });

  document.getElementById('stagesWorkshops').innerHTML = wsHtml;
  document.getElementById('stagesDecisions').innerHTML = dwHtml;
  document.getElementById('allStages').innerHTML = allHtml;
}

function renderIntelligenceSummary() {
  const readiness = computeReadinessScore(STATE.responses);

  let html = `
    <div style="text-align: center;">
      <div class="val" style="font-size: 32px; color: #D97706;">${readiness}%</div>
      <div class="lbl">Overall Readiness</div>
    </div>
    <div style="text-align: center;">
      <div class="val" style="font-size: 32px; color: var(--ok);">72%</div>
      <div class="lbl">Avg Consensus</div>
    </div>
    <div style="text-align: center;">
      <div class="val" style="font-size: 32px; color: var(--error);">4</div>
      <div class="lbl">Risk Signals</div>
    </div>
  `;

  document.getElementById('intelSummary').innerHTML = html;
}

function renderDecisionAnalysis() {
  const d5Responses = STATE.responses
    .filter(r => r.Q5)
    .map(r => ({ role: r.role, answer: r.Q5 }));

  const d5Consensus = computeConsensusForDecision(d5Responses, 'D5');

  let html = `
    <div class="intel-card">
      <div class="dec-id">D5 ‚Äî Governance Model (Most Contentious)</div>
      <h4>Centralized vs Hybrid vs Decentralized Decision</h4>
      <p class="desc" style="font-size: 12px; line-height: 1.5; margin-bottom: 12px;">
        Core decision on governance model: centralized global control vs hybrid hub-and-spoke vs decentralized regional autonomy.
      </p>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <div style="font-size: 11px; font-weight: 700; color: var(--navy); margin-bottom: 8px;">RESPONSE DISTRIBUTION</div>
          <div class="consensus-bar">
            <div class="label">Hybrid</div>
            <div class="track"><div class="fill" style="width: 50%;">50%</div></div>
            <div class="pct">6 votes</div>
          </div>
          <div class="consensus-bar">
            <div class="label">Centralized</div>
            <div class="track"><div class="fill" style="width: 33%; background: #999;">33%</div></div>
            <div class="pct">4 votes</div>
          </div>
          <div class="consensus-bar">
            <div class="label">Decentralized</div>
            <div class="track"><div class="fill" style="width: 17%; background: #ccc;">17%</div></div>
            <div class="pct">2 votes</div>
          </div>
        </div>
        <div>
          <div style="font-size: 11px; font-weight: 700; color: var(--navy); margin-bottom: 8px;">ROLE DIVERGENCE</div>
          <div class="consensus-bar">
            <div class="label">Exec ‚Üî Regional</div>
            <div class="track"><div class="fill" style="width: 55%; background: var(--error);">55%</div></div>
            <div class="pct">Divergent</div>
          </div>
          <div class="consensus-bar">
            <div class="label">Tech ‚Üî Operational</div>
            <div class="track"><div class="fill" style="width: 40%; background: var(--warn);">40%</div></div>
            <div class="pct">Divergent</div>
          </div>
          <div class="consensus-bar">
            <div class="label">Exec ‚Üî Technical</div>
            <div class="track"><div class="fill" style="width: 20%; background: var(--ok);">20%</div></div>
            <div class="pct">Aligned</div>
          </div>
        </div>
      </div>
    </div>
  `;

  document.getElementById('decisionAnalysisCards').innerHTML = html;
}

function renderRiskDashboard() {
  const risks = STATE.analysis.risks;

  let html = '';
  risks.forEach(risk => {
    const severityColor = risk.severity === 'High' ? '#CC3300' : '#E8911A';
    html += `
      <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
        <div style="width: 3px; height: 60px; background: ${severityColor}; border-radius: 2px; flex-shrink: 0;"></div>
        <div style="flex: 1;">
          <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 4px;">
            <strong style="font-size: 13px;">${risk.title}</strong>
            <span class="risk-badge risk-${risk.severity.toLowerCase()}">${risk.severity}</span>
            <span class="risk-badge" style="background: #e0f2f1; color: #006462;">${risk.category}</span>
          </div>
          <div style="font-size: 12px; color: #666; line-height: 1.5;">${risk.description}</div>
        </div>
      </div>
    `;
  });

  document.getElementById('riskDashboard').innerHTML = html;
}

function renderStakeholderTable() {
  const responses = STATE.responses;

  let html = '';
  responses.forEach(r => {
    const badgeClass = r.role === 'Executive' ? 'badge-exec' : r.role === 'Operational' ? 'badge-ops' : r.role === 'Technical' ? 'badge-tech' : 'badge-regional';
    const concern = (r.Q32 && r.Q32.substring(0, 40) + '...') || 'Alignment focus';
    const readiness = ((r.Q13 || 0) + (r.Q16 || 0) + (r.Q26 || 0)) / 15 * 100;
    const watch = readiness < 60 ? 'Watch' : 'On track';
    const watchColor = watch === 'Watch' ? 'var(--error)' : 'var(--ok)';

    html += `
      <tr>
        <td><strong>${r.name}</strong></td>
        <td><span class="badge ${badgeClass}">${r.role}</span></td>
        <td style="font-size: 12px;">${r.department}</td>
        <td style="font-size: 12px;">${Math.round(readiness)}%</td>
        <td style="font-size: 12px;">${concern}</td>
        <td><span style="color: ${watchColor}; font-weight: 700; font-size: 12px;">${watch}</span></td>
      </tr>
    `;
  });

  document.getElementById('stakeholderTable').innerHTML = html;
}

function renderChecklists() {
  const checklists = {
    ws1: ['Workshop invitation sent', 'Pre-survey completed', 'Intelligence analyzed', 'Facilitator briefing prepared', 'Slides finalized'],
    ws2: ['Survey designed', 'Role analysis complete', 'Artifacts generated', 'Workshop scheduled'],
    ws3: ['Survey content reviewed', 'Multi-language scope', 'ADKAR segmentation', 'Design locked'],
    ws4: ['Platform architecture defined', 'Metadata model built', 'API specifications', 'Test scenarios'],
    dw1: ['E2E process mapped', 'SLA definitions', 'Intake form spec', 'Access matrix'],
    dw2: ['Dashboard designs', 'Alert thresholds', 'Ticketing rules', 'Escalation paths']
  };

  Object.entries(checklists).forEach(([key, items]) => {
    let html = '';
    items.forEach((item, idx) => {
      const checked = key === 'ws1' || key === 'dw1' || (key === 'ws2' && idx < 2);
      html += `
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
          <input type="checkbox" ${checked ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;"/>
          <label style="font-size: 13px; cursor: pointer; flex: 1;">${item}</label>
        </div>
      `;
    });
    const elId = 'checklist' + key.toUpperCase();
    const el = document.getElementById(elId);
    if (el) el.innerHTML = html;
  });
}

function renderTimeline() {
  const timelinePhase1 = `
    <div style="margin-bottom: 16px;">
      <div style="font-size: 13px; font-weight: 700; margin-bottom: 8px;">WS1: Governance & Decision Framework</div>
      <div style="font-size: 12px; color: var(--gray); line-height: 1.6;">
        <strong>Date:</strong> March 12, 2026 | <strong>Duration:</strong> 2.5 hours<br/>
        <strong>Participants:</strong> 12 senior stakeholders (Exec, Ops, Tech, Regional)<br/>
        <strong>Outputs:</strong> 8 decisions finalized, roles RACI, fatigue guardrails, governance model
      </div>
    </div>
    <div style="margin-bottom: 16px;">
      <div style="font-size: 13px; font-weight: 700; margin-bottom: 8px;">WS2: Stakeholder Mapping & Communications</div>
      <div style="font-size: 12px; color: var(--gray); line-height: 1.6;">
        <strong>Target:</strong> Late March 2026<br/>
        <strong>Participants:</strong> Change leads, comms, select ops<br/>
        <strong>Outputs:</strong> Impacted groups map, comms calendar, cascade plan
      </div>
    </div>
    <div style="margin-bottom: 16px;">
      <div style="font-size: 13px; font-weight: 700; margin-bottom: 8px;">WS3: Survey Content & Design</div>
      <div style="font-size: 12px; color: var(--gray); line-height: 1.6;">
        <strong>Target:</strong> Early April 2026<br/>
        <strong>Participants:</strong> Survey designers, HR, tech leads<br/>
        <strong>Outputs:</strong> Question bank, multi-language, ADKAR mapping, field worker flows
      </div>
    </div>
    <div>
      <div style="font-size: 13px; font-weight: 700; margin-bottom: 8px;">WS4: Platform & Metadata Architecture</div>
      <div style="font-size: 12px; color: var(--gray); line-height: 1.6;">
        <strong>Target:</strong> Mid April 2026<br/>
        <strong>Participants:</strong> IT, Qualtrics admins, data engineers<br/>
        <strong>Outputs:</strong> Platform specs, dashboard designs, API plan, testing strategy
      </div>
    </div>
  `;

  const timelinePhase2 = `
    <div style="margin-bottom: 16px;">
      <div style="font-size: 13px; font-weight: 700; margin-bottom: 8px;">DW1: E2E Process Decisions</div>
      <div style="font-size: 12px; color: var(--gray); line-height: 1.6;">
        <strong>Target:</strong> Late April 2026<br/>
        <strong>Participants:</strong> GTO, program leads, operational teams<br/>
        <strong>Outputs:</strong> E2E process SLAs, intake spec, platform access matrix
      </div>
    </div>
    <div>
      <div style="font-size: 13px; font-weight: 700; margin-bottom: 8px;">DW2: Dashboards & Ticketing Decisions</div>
      <div style="font-size: 12px; color: var(--gray); line-height: 1.6;">
        <strong>Target:</strong> Early May 2026<br/>
        <strong>Participants:</strong> Analytics, ops, escalation owners<br/>
        <strong>Outputs:</strong> Dashboard role views, alert thresholds, ticketing rules, escalation matrices
      </div>
    </div>
  `;

  const timelinePhase3 = `
    <div style="margin-bottom: 16px;">
      <div style="font-size: 13px; font-weight: 700; margin-bottom: 8px;">Pilot Launch (FPL Region)</div>
      <div style="font-size: 12px; color: var(--gray); line-height: 1.6;">
        <strong>Target:</strong> May 15 - June 15, 2026<br/>
        <strong>Focus:</strong> Field worker accessibility, SMS/QR approach, Spanish language<br/>
        <strong>Success Metrics:</strong> 60%+ completion rate, zero critical bugs, positive stakeholder feedback
      </div>
    </div>
    <div>
      <div style="font-size: 13px; font-weight: 700; margin-bottom: 8px;">Global Rollout</div>
      <div style="font-size: 12px; color: var(--gray); line-height: 1.6;">
        <strong>Target:</strong> June 15 - August 31, 2026<br/>
        <strong>Sequence:</strong> Regional HR teams, then corporate, then field operations<br/>
        <strong>Success Criteria:</strong> 70%+ engagement, zero escalations due to process gaps
      </div>
    </div>
  `;

  document.getElementById('timelinePhase1').innerHTML = timelinePhase1;
  document.getElementById('timelinePhase2').innerHTML = timelinePhase2;
  document.getElementById('timelinePhase3').innerHTML = timelinePhase3;
}

// ============================================================================
// INTELLIGENCE ENGINE: WIZARD FUNCTIONS
// ============================================================================

function ieGoStep(panelId) {
  document.querySelectorAll('.ie-panel').forEach(p => p.classList.remove('ie-act'));
  document.querySelectorAll('.ie-step').forEach(s => s.classList.remove('ie-act'));

  const targetPanel = document.getElementById(panelId);
  if (targetPanel) targetPanel.classList.add('ie-act');

  const targetStep = document.querySelector(`.ie-step[data-p="${panelId}"]`);
  if (targetStep) targetStep.classList.add('ie-act');

  const stepOrder = ['ie-p1', 'ie-p2', 'ie-p3', 'ie-p4'];
  const currentIndex = stepOrder.indexOf(panelId);
  stepOrder.forEach((stepId, idx) => {
    const stepEl = document.querySelector(`.ie-step[data-p="${stepId}"]`);
    if (stepEl) {
      if (idx < currentIndex) {
        stepEl.classList.add('ie-done');
      } else {
        stepEl.classList.remove('ie-done');
      }
    }
  });

  STATE.ieCurrentStep = panelId;
}

function ieLoadDemoData() {
  STATE.ieResponses = DEMO_DATA;
  STATE.ieClientName = 'Nextera Energy Inc.';
  STATE.ieWorkshopDate = '2026-03-12';

  document.getElementById('ieCName').value = STATE.ieClientName;
  document.getElementById('ieCProg').value = 'Grid Modernization Transformation Program (GMTP)';
  document.getElementById('ieWDate').value = STATE.ieWorkshopDate;
  document.getElementById('ieALead').value = 'James Whitford';
  document.getElementById('ieWDur').value = '2.5 hours';

  ieShowDataPreview();
  document.getElementById('ieBtnAnalyze').disabled = false;
}

function ieShowDataPreview() {
  const responses = STATE.ieResponses;

  const roleCount = {};
  responses.forEach(r => {
    roleCount[r.role] = (roleCount[r.role] || 0) + 1;
  });

  const respStatsEl = document.getElementById('ieRespStats');
  if (respStatsEl) {
    respStatsEl.innerHTML = `
      <div class="ie-stat"><div class="ie-val">${responses.length}</div><div class="ie-lbl">Total Respondents</div></div>
      <div class="ie-stat"><div class="ie-val">100%</div><div class="ie-lbl">Completion Rate</div></div>
      <div class="ie-stat"><div class="ie-val">${Object.keys(roleCount).length}</div><div class="ie-lbl">Role Segments</div></div>
      <div class="ie-stat"><div class="ie-val">33</div><div class="ie-lbl">Total Questions</div></div>
    `;
  }

  const roleBreakdownEl = document.getElementById('ieRoleBreakdown');
  if (roleBreakdownEl) {
    let barChartHTML = Object.entries(roleCount).map(([role, count]) => {
      const pct = Math.round((count / responses.length) * 100);
      return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
        <div style="font-size:11px;color:var(--gray);width:120px;text-align:right;flex-shrink:0">${role}</div>
        <div style="flex:1;height:18px;background:var(--off-white);border-radius:4px;overflow:hidden">
          <div style="height:100%;width:${pct}%;background:var(--orange);display:flex;align-items:center;padding-left:6px;font-size:10px;font-weight:600;color:#fff">${count}</div>
        </div>
        <div style="font-size:11px;color:var(--gray);width:36px;flex-shrink:0">${pct}%</div>
      </div>`;
    }).join('');

    roleBreakdownEl.innerHTML = `
      <div style="margin-top:16px">
        <div style="font-size:13px;font-weight:700;margin-bottom:10px">Respondent Breakdown by Role:</div>
        ${barChartHTML}
      </div>
    `;
  }

  const previewEl = document.getElementById('ieDataPreview');
  if (previewEl) previewEl.style.display = 'block';
}

function ieHandleFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const content = e.target.result;
    const lines = content.split(/\r?\n/).filter(line => line.trim());

    if (lines.length < 2) {
      alert('CSV file must contain headers and data');
      return;
    }

    const headerLine = lines[0];
    const headers = ieParseCsvLine(headerLine);
    const responses = [];

    for (let i = 1; i < lines.length; i++) {
      const parts = ieParseCsvLine(lines[i]);

      const response = {
        responseId: ieExtractField(parts, headers, 'ResponseID') || `R${i}`,
        name: ieExtractField(parts, headers, 'Q1') || '',
        role: ieExtractField(parts, headers, 'Q2') || '',
        department: ieExtractField(parts, headers, 'Q3') || '',
        email: ieExtractField(parts, headers, 'Q4') || ''
      };

      for (let qNum = 5; qNum <= 33; qNum++) {
        const qId = `Q${qNum}`;
        const value = ieExtractField(parts, headers, qId);
        if (value !== null) {
          response[qId] = value;
        }
      }

      if (response.role && response.role.trim()) {
        responses.push(response);
      }
    }

    STATE.ieResponses = responses;
    ieShowDataPreview();
    document.getElementById('ieBtnAnalyze').disabled = false;
  };

  reader.readAsText(file);
}

function ieParseCsvLine(line) {
  const result = [];
  let current = '';
  let insideQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    const nextChar = line[i + 1];

    if (char === '"') {
      if (insideQuotes && nextChar === '"') {
        current += '"';
        i++;
      } else {
        insideQuotes = !insideQuotes;
      }
    } else if (char === ',' && !insideQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }

  result.push(current.trim());
  return result;
}

function ieExtractField(parts, headers, qId) {
  const colIndex = headers.findIndex(h => h.toLowerCase().includes(qId.toLowerCase()));
  if (colIndex === -1) return null;
  if (colIndex >= parts.length) return null;
  const value = parts[colIndex];
  return value === '' ? null : value;
}

function ieRunAnalysis() {
  if (!STATE.ieResponses || STATE.ieResponses.length === 0) {
    alert('No responses loaded for analysis');
    return;
  }

  const responses = STATE.ieResponses;
  const analysis = {
    overallReadiness: 68,
    avgConsensus: 72,
    riskCount: 4,
    openPointCount: 9,
    roleDistribution: {},
    decisionScores: {}
  };

  const roleCount = {};
  responses.forEach(r => {
    roleCount[r.role] = (roleCount[r.role] || 0) + 1;
  });

  analysis.roleDistribution = Object.entries(roleCount).map(([role, count]) => ({
    role,
    count,
    pct: Math.round((count / responses.length) * 100)
  }));

  STATE.ieAnalysis = analysis;
  ieRenderIntelligencePanel();
  ieGoStep('ie-p3');
}

function ieRenderIntelligencePanel() {
  if (!STATE.ieAnalysis) return;

  const analysis = STATE.ieAnalysis;
  const el = document.getElementById('ieIntStats');

  if (el) {
    el.innerHTML = `
      <div class="ie-stat">
        <div class="ie-val" style="color: ${analysis.overallReadiness > 70 ? '#468A4B' : analysis.overallReadiness > 50 ? '#F9A13A' : '#CC3300'}">${analysis.overallReadiness}%</div>
        <div class="ie-lbl">Readiness Score</div>
      </div>
      <div class="ie-stat">
        <div class="ie-val">${analysis.avgConsensus}%</div>
        <div class="ie-lbl">Avg Consensus</div>
      </div>
      <div class="ie-stat">
        <div class="ie-val">${analysis.riskCount}</div>
        <div class="ie-lbl">Identified Risks</div>
      </div>
      <div class="ie-stat">
        <div class="ie-val">${analysis.openPointCount}</div>
        <div class="ie-lbl">Open Points</div>
      </div>
    `;
  }

  const decEl = document.getElementById('ieDecisionAnalysis');
  if (decEl) {
    let html = '';
    for (let d = 1; d <= 8; d++) {
      const consensus = 45 + Math.random() * 50;
      html += `
        <div class="card" style="border-left: 4px solid var(--orange); margin-bottom: 14px;">
          <div style="font-size: 10px; font-weight: 700; color: var(--orange); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px;">D${d} ‚Äî Decision ${d}</div>
          <h4 style="font-size: 15px; font-weight: 700; color: var(--navy); margin-bottom: 4px;">Decision Title ${d}</h4>
          <p style="font-size: 13px; color: #333; line-height: 1.6; margin-bottom: 10px; padding: 10px 14px; background: var(--off-white); border-radius: 6px; border-left: 3px solid var(--orange);">
            Intelligence summary based on stakeholder responses for this decision point.
          </p>
          <div style="display:flex;align-items:center;gap:10px;margin:8px 0;font-size:12px;">
            <div style="width:100px;flex-shrink:0;color:var(--gray)">Consensus</div>
            <div style="flex:1;height:16px;background:var(--off-white);border-radius:8px;overflow:hidden">
              <div style="height:100%;width:${Math.round(consensus)}%;background:var(--ok);display:flex;align-items:center;padding-left:6px;font-size:10px;font-weight:600;color:#fff">${Math.round(consensus)}%</div>
            </div>
          </div>
        </div>
      `;
    }
    decEl.innerHTML = html;
  }
}

// ============================================================================
// INTELLIGENCE ENGINE: COMPREHENSIVE PPTX DECK GENERATION
// ============================================================================

// Helper: Add slide accent bar and footer
function ieSlideTopBar(slide) {
  slide.addShape("rect", {
    x: 0, y: 0, w: 10, h: 0.06,
    fill: { color: 'F9A13A' },
    line: { type: 'none' },
    margin: 0
  });
}

function ieSlideFooter(slide, slideNum) {
  slide.addShape("rect", {
    x: 0, y: 5.25, w: 10, h: 0.375,
    fill: { color: 'FEF0DB' },
    line: { type: 'none' },
    margin: 0
  });

  slide.addText(`${slideNum}`, {
    x: 9.5, y: 5.3, w: 0.4, h: 0.3,
    fontSize: 10, color: '8a7e6e', align: 'right',
    margin: 0
  });
}

// Helper: Get role counts from responses
function ieGetRoleCounts() {
  const counts = { Executive: 0, Operational: 0, Technical: 0, Regional: 0 };
  STATE.responses.forEach(r => {
    if (counts.hasOwnProperty(r.role)) counts[r.role]++;
  });
  return counts;
}

// Helper: Get top N wins (highest consensus decisions)
function ieGetTopWins(n = 3) {
  const decisions = [
    { id: 1, title: 'Roles & Responsibilities', consensus: 75 },
    { id: 3, title: 'Intake Form Design', consensus: 72 },
    { id: 7, title: 'Operating Cadence', consensus: 74 },
    { id: 6, title: 'Fatigue Guardrails', consensus: 71 },
    { id: 5, title: 'Governance Model', consensus: 70 },
    { id: 2, title: 'E2E Survey Process', consensus: 68 },
    { id: 4, title: 'Global vs Regional Rights', consensus: 65 },
    { id: 8, title: 'Data Ownership & Quality', consensus: 62 }
  ];
  return decisions.sort((a, b) => b.consensus - a.consensus).slice(0, n);
}

// Helper: Get top N risks
function ieGetTopRisks(n = 4) {
  const analysis = STATE.analysis || {};
  const risks = analysis.risks || [];
  const severityMap = { Critical: 0, High: 1, Medium: 2, Low: 3 };
  return risks.sort((a, b) => severityMap[a.severity] - severityMap[b.severity]).slice(0, n);
}

// Helper: Get per-stakeholder summary table data
function ieGetStakeholderTable() {
  return (STATE.responses || []).map(r => ({
    name: r.name,
    role: r.role,
    department: r.department,
    concern: r.Q31 || r.Q32 || 'None identified',
    alignment: r.Q16 && r.Q16 >= 4 ? 'High' : r.Q16 >= 3 ? 'Medium' : 'Low'
  }));
}

// Helper: Generate insight text from analysis
function ieGenerateInsightText() {
  const analysis = STATE.analysis || {};
  const risks = analysis.risks || [];
  const readiness = analysis.readiness || 68;

  if (readiness > 75) {
    return 'Strong organizational readiness. Team alignment on governance is high. Focus on execution excellence.';
  } else if (readiness > 60) {
    return 'Moderate readiness with pockets of strong alignment. Address role clarity and data governance concerns to accelerate.';
  } else {
    return 'Below-target readiness indicates capacity constraints and alignment gaps. Prioritize decision framework and stakeholder engagement.';
  }
}

// Helper: Generate single decision slide
function ieGenerateDecisionSlide(pres, decIdx) {
  const decisions = [
    {
      id: 1,
      title: 'Roles & Responsibilities',
      description: 'How should decision-making authority be distributed across Executive, Operational, Technical, and Regional stakeholders?',
      consensus: 75,
      summary: 'Clear role definitions with escalation paths. Executive owns governance framework; Operational owns execution cadence; Technical owns integration; Regional owns local implementation.',
      status: 'Strong Alignment',
      adkarStages: ['Awareness', 'Desire'],
      quotes: ['FPL is ready', 'Need clear decision trees', 'Regional leads need autonomy']
    },
    {
      id: 2,
      title: 'E2E Survey Process',
      description: 'What is the complete end-to-end process from intake request through insights distribution?',
      consensus: 68,
      summary: 'Process includes intake, launch coordination, response collection (web + SMS/QR), data validation, and analysis distribution. Regional variations approved within global guardrails.',
      status: 'Needs Discussion',
      adkarStages: ['Awareness', 'Understanding'],
      quotes: ['Process maturity variation across regions', 'Email-only won\'t reach our people', 'Established employee networks']
    },
    {
      id: 3,
      title: 'Intake Form Design',
      description: 'Should we standardize on simple intake (5-10 fields) or detailed metadata (20+ fields)?',
      consensus: 72,
      summary: 'Hybrid approach: core 7-field standard form (title, description, target population, timeline, response format, escalation type, owner) with optional metadata module for advanced use cases.',
      status: 'Strong Alignment',
      adkarStages: ['Understanding', 'Acceptance'],
      quotes: ['Balance simplicity vs. metadata requirements', 'Keep intake simple for field workers', 'Need integration with Glint']
    },
    {
      id: 4,
      title: 'Global vs Regional Rights',
      description: 'Which decisions are global (uniform rules) vs shared (regional variation within framework) vs local (full autonomy)?',
      consensus: 65,
      summary: 'Three-tier governance: Global (contact frequency limits, data retention), Shared (intake fields, reporting templates), Local (survey timing, communication methods).',
      status: 'Needs Discussion',
      adkarStages: ['Understanding', 'Acceptance'],
      quotes: ['Hub & spoke tension between exec and regional leads', 'Regions have different maturity', 'Need flexibility for different NEER sub-regions']
    },
    {
      id: 5,
      title: 'Governance Model',
      description: 'Centralized (global decision-making), Hybrid (global framework + regional execution), or Decentralized (regional autonomy)?',
      consensus: 70,
      summary: 'Recommended: Hybrid model with global guardrails (fatigue, data, compliance), shared decision templates, and regional autonomy on execution cadence and communication.',
      status: 'Strong Alignment',
      adkarStages: ['Acceptance', 'Commitment'],
      quotes: ['Hybrid model adoption and accountability', 'Need clear boundaries', 'Regional context critical']
    },
    {
      id: 6,
      title: 'Fatigue Guardrails',
      description: 'What are the rules to prevent survey fatigue (contact frequency limits, competing survey coordination, mandatory breaks)?',
      consensus: 71,
      summary: 'Max 1 survey per employee per quarter. Mandatory breaks Dec 15-Jan 15 (Glint blackout). Conflict-of-interest review for overlapping initiatives. Escalation to Sponsor if violated.',
      status: 'Strong Alignment',
      adkarStages: ['Acceptance', 'Commitment'],
      quotes: ['Contact frequency limits and competing surveys', 'Glint blackout alignment needed', 'Change fatigue risk']
    },
    {
      id: 7,
      title: 'Operating Cadence',
      description: 'Should CMX operate on Monthly pulse surveys, Quarterly deep dives, or Event-driven (milestone-based)?',
      consensus: 74,
      summary: 'Recommended: Quarterly deep dives as baseline with optional monthly pulse surveys in focused areas. Event-driven options available for crisis response or major milestones.',
      status: 'Strong Alignment',
      adkarStages: ['Acceptance', 'Commitment'],
      quotes: ['Monthly vs quarterly rhythm preference', 'Different regional needs', 'Established cadence required']
    },
    {
      id: 8,
      title: 'Data Ownership & Quality',
      description: 'Who owns the Contact Directory? How is metadata quality maintained? What is the data classification (NERC CIP scope)?',
      consensus: 62,
      summary: 'Data Steward owns Contact Directory with quarterly cleanse. IT owns HRIS integration and API governance. Compliance owns NERC CIP classification. Metadata enrichment is manual in MVP.',
      status: 'Needs Discussion',
      adkarStages: ['Understanding', 'Acceptance'],
      quotes: ['HRIS integration and metadata quality', 'Contact Directory quality is key blocker', 'Metadata enrichment is manual']
    }
  ];

  const dec = decisions[decIdx];
  let slide = pres.addSlide();
  slide.background = { color: 'FFFFFF' };
  ieSlideTopBar(slide);

  // Title
  slide.addText(`D${dec.id}: ${dec.title}`, {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 28, bold: true, fontFace: 'Georgia', color: '2D2015',
    margin: 0
  });

  // Consensus badge
  const consensusColor = dec.consensus >= 70 ? '2e8540' : dec.consensus >= 60 ? 'c07600' : 'c73e1d';
  slide.addShape("rect", {
    x: 0.5, y: 0.55, w: 0.8, h: 0.25,
    fill: { color: consensusColor }, line: { type: 'none' },
    margin: 0
  });

  slide.addText(`${dec.consensus}%`, {
    x: 0.5, y: 0.55, w: 0.8, h: 0.25,
    fontSize: 13, bold: true, color: 'FFFFFF', align: 'center', valign: 'middle',
    margin: 0
  });

  // Status label
  slide.addText(dec.status, {
    x: 1.35, y: 0.57, w: 1.2, h: 0.21,
    fontSize: 10, bold: true, color: '8a7e6e',
    margin: 0
  });

  // Description box
  slide.addShape("rect", {
    x: 0.5, y: 0.9, w: 4.5, h: 1.2,
    fill: { color: 'FEF0DB' }, line: { color: 'E0D8CE', width: 1 },
    margin: 0
  });

  slide.addText('Question', {
    x: 0.65, y: 0.95, w: 4.2, h: 0.18,
    fontSize: 9, bold: true, color: 'F9A13A', margin: 0
  });

  slide.addText(dec.description, {
    x: 0.65, y: 1.15, w: 4.2, h: 0.9,
    fontSize: 9, color: '3A3028', valign: 'top', margin: 0
  });

  // Summary box
  slide.addShape("rect", {
    x: 5.2, y: 0.9, w: 4.3, h: 1.2,
    fill: { color: 'FFFFFF' }, line: { color: 'E0D8CE', width: 1 },
    margin: 0
  });

  slide.addText('Recommendation', {
    x: 5.35, y: 0.95, w: 4, h: 0.18,
    fontSize: 9, bold: true, color: 'F9A13A', margin: 0
  });

  slide.addText(dec.summary, {
    x: 5.35, y: 1.15, w: 4, h: 0.9,
    fontSize: 9, color: '3A3028', valign: 'top', margin: 0
  });

  // ADKAR stages
  slide.addText('ADKAR Stages:', {
    x: 0.5, y: 2.15, w: 2, h: 0.2,
    fontSize: 9, bold: true, color: '2D2015', margin: 0
  });

  let stageX = 0.5;
  dec.adkarStages.forEach((stage, idx) => {
    const colors_map = ['E8F5EB', 'E3F0FA', 'FFF4E0'];
    const color = colors_map[idx % 3];
    slide.addShape("rect", {
      x: stageX, y: 2.38, w: 1.3, h: 0.22,
      fill: { color: color }, line: { type: 'none' },
      margin: 0
    });
    slide.addText(stage, {
      x: stageX, y: 2.38, w: 1.3, h: 0.22,
      fontSize: 8, color: '2D2015', align: 'center', valign: 'middle',
      margin: 0
    });
    stageX += 1.35;
  });

  // Stakeholder quotes
  slide.addText('Stakeholder Signals:', {
    x: 0.5, y: 2.7, w: 9, h: 0.2,
    fontSize: 9, bold: true, color: '2D2015', margin: 0
  });

  let quoteY = 2.92;
  dec.quotes.forEach((quote, idx) => {
    if (idx < 3) {
      slide.addText(`"${quote}"`, {
        x: 0.65, y: quoteY, w: 8.7, h: 0.35,
        fontSize: 8, italic: true, color: '737373', margin: 0
      });
      quoteY += 0.4;
    }
  });

  // Facilitator note
  slide.addShape("rect", {
    x: 0.5, y: 4.6, w: 9, h: 0.55,
    fill: { color: 'F7F5F2' }, line: { color: 'E0D8CE', width: 1 },
    margin: 0
  });

  slide.addText('FACILITATOR NOTE', {
    x: 0.65, y: 4.65, w: 8.7, h: 0.15,
    fontSize: 8, bold: true, color: 'F9A13A', margin: 0
  });

  const facilitatorNotes = {
    1: 'Start here. Clear roles remove ambiguity. Use RACI matrix to capture decisions.',
    2: 'Process is the foundation. Validate end-to-end with Technical + Operational. Document decision points.',
    3: 'Seek consensus on standard form. Allow opt-in metadata for advanced users. Demo intake prototype.',
    4: 'This is contentious. Show "decision type" examples (Global=fatigue rules, Shared=templates, Local=timing).',
    5: 'Hybrid is emerging consensus. Validate boundaries between global guardrails and regional autonomy.',
    6: 'Non-negotiable. Present Glint calendar integration. Quantify survey load across existing initiatives.',
    7: 'Test appetite for monthly pulse within quarterly framework. Show resource implications.',
    8: 'Data quality is a known blocker. Present Contact Directory cleanup plan. NERC CIP impacts scope.'
  };

  slide.addText(facilitatorNotes[dec.id], {
    x: 0.65, y: 4.82, w: 8.7, h: 0.28,
    fontSize: 8, color: '3A3028', valign: 'top', margin: 0
  });

  ieSlideFooter(slide, 17 + decIdx);
}

function ieGenerateDeck() {
  if (!STATE.responses || STATE.responses.length === 0) {
    alert('No responses loaded. Please load survey data first.');
    return;
  }

  const pres = new PptxGenJS();
  pres.defineLayout({ name: 'LAYOUT_16x9', width: 10, height: 5.625 });
  pres.layout = 'LAYOUT_16x9';

  const colors = {
    navy: '2D2015',
    navyLight: '3a2c1c',
    orange: 'F9A13A',
    orangeDark: 'E8911A',
    cream: 'FEF0DB',
    offWhite: 'F7F5F2',
    white: 'FFFFFF',
    text: '3A3028',
    gray: '8a7e6e',
    lightGray: 'E0D8CE',
    green: '2e8540',
    greenBg: 'E8F5EB',
    red: 'c73e1d',
    redBg: 'FCE8E4',
    amber: 'c07600',
    amberBg: 'FFF4E0',
    blue: '1a73b5',
    blueBg: 'E3F0FA',
    teal: '006462'
  };

  const clientName = STATE.ieClientName || 'Nextera Energy Inc.';
  const programName = 'Grid Modernization Transformation Program';
  const workshopDate = STATE.ieWorkshopDate || '2026-03-12';
  let slideNum = 1;

  // ========== SECTION 1: OPENING (Slides 1-2) ==========

  // SLIDE 1: Title Slide
  let slide = pres.addSlide();
  slide.background = { color: colors.navy };

  slide.addShape("rect", {
    x: 0, y: 0, w: 0.12, h: 5.625,
    fill: { color: colors.orange }, line: { type: 'none' }, margin: 0
  });

  slide.addText('akt', {
    x: 0.5, y: 0.8, w: 2.5, h: 0.5,
    fontSize: 48, bold: true, fontFace: 'Arial Black', color: colors.orange, margin: 0
  });

  slide.addText('CMX Foundations', {
    x: 0.5, y: 1.35, w: 8.5, h: 0.4,
    fontSize: 38, fontFace: 'Georgia', bold: true, color: colors.white, margin: 0
  });

  slide.addText('Workshop 1: Process Design & Governance', {
    x: 0.5, y: 1.8, w: 8.5, h: 0.35,
    fontSize: 26, fontFace: 'Georgia', color: colors.cream, margin: 0
  });

  slide.addText(clientName, {
    x: 0.5, y: 2.3, w: 8.5, h: 0.25,
    fontSize: 16, color: 'CCCCCC', margin: 0
  });

  slide.addText(programName, {
    x: 0.5, y: 2.6, w: 8.5, h: 0.22,
    fontSize: 13, color: '999999', margin: 0
  });

  slide.addShape("rect", {
    x: 0.5, y: 3.0, w: 8.5, h: 0.015,
    fill: { color: colors.orange }, line: { type: 'none' }, margin: 0
  });

  slide.addText(workshopDate, {
    x: 0.5, y: 3.15, w: 4, h: 0.22,
    fontSize: 12, color: '999999', margin: 0
  });

  slide.addText('Pre-populated with stakeholder intelligence', {
    x: 0.5, y: 3.42, w: 8.5, h: 0.18,
    fontSize: 11, italic: true, color: '999999', margin: 0
  });

  // Footer bar
  slide.addShape("rect", {
    x: 0, y: 5.465, w: 10, h: 0.16,
    fill: { color: colors.orange }, line: { type: 'none' }, margin: 0
  });

  slideNum++;

  // SLIDE 2: Agenda
  slide = pres.addSlide();
  slide.background = { color: colors.white };
  ieSlideTopBar(slide);

  slide.addText('Workshop Agenda', {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 32, fontFace: 'Georgia', bold: true, color: colors.navy, margin: 0
  });

  const agendaItems = [
    { time: '9:00-9:30', topic: 'Stakeholder Intelligence Briefing: Pre-Session Analysis & Key Findings' },
    { time: '9:30-10:30', topic: 'Scope & Expectations: Workshop Goals & Governance Framework Overview' },
    { time: '10:45-12:00', topic: 'Decision 1-4 Deep-Dive: Roles, Process, Intake, Rights & Authority' },
    { time: '1:00-2:30', topic: 'Decision 5-8 Deep-Dive: Governance Model, Fatigue, Cadence, Data Ownership' },
    { time: '2:45-3:45', topic: 'Process Mapping: Key Design Elements & Workflow Orchestration' },
    { time: '3:45-4:00', topic: 'Cascade Preview & Next Steps: Workshop 2-4 Dependencies' }
  ];

  let agendaY = 0.65;
  agendaItems.forEach((item, idx) => {
    slide.addText(item.time, {
      x: 0.5, y: agendaY, w: 1.2, h: 0.25,
      fontSize: 10, bold: true, color: colors.orange, margin: 0
    });

    slide.addText(item.topic, {
      x: 1.8, y: agendaY, w: 7.7, h: 0.25,
      fontSize: 10, color: colors.text, margin: 0
    });

    agendaY += 0.4;
  });

  ieSlideFooter(slide, slideNum);
  slideNum++;

  // ========== SECTION 2: STAKEHOLDER INTELLIGENCE (Slides 3-6) ==========

  // SLIDE 3: Stakeholder Intelligence Overview
  slide = pres.addSlide();
  slide.background = { color: colors.white };
  ieSlideTopBar(slide);

  slide.addText('Stakeholder Intelligence Overview', {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 32, fontFace: 'Georgia', bold: true, color: colors.navy, margin: 0
  });

  const analysis = STATE.analysis || {};
  const readiness = analysis.readiness || 68;
  const avgConsensus = 70; // Average of 8 decisions
  const riskCount = (analysis.risks || []).length || 4;
  const openPointCount = (analysis.openPoints || []).length || 9;

  const heroCards = [
    { val: `${readiness}%`, lbl: 'Overall Readiness', color: 'D97706', key: 'readiness' },
    { val: `${avgConsensus}%`, lbl: 'Average Consensus', color: '2e8540', key: 'consensus' },
    { val: `${riskCount}`, lbl: 'Risk Signals', color: 'c73e1d', key: 'risks' },
    { val: `${openPointCount}`, lbl: 'Open Points', color: '1a73b5', key: 'openpoints' }
  ];

  let cardX = 0.5;
  heroCards.forEach(card => {
    slide.addShape("rect", {
      x: cardX, y: 0.65, w: 2.1, h: 1.3,
      fill: { color: colors.white }, line: { color: colors.lightGray, width: 1 }, margin: 0
    });

    slide.addText(card.val, {
      x: cardX, y: 0.8, w: 2.1, h: 0.45,
      fontSize: 40, bold: true, color: card.color, align: 'center', margin: 0
    });

    slide.addText(card.lbl, {
      x: cardX, y: 1.3, w: 2.1, h: 0.35,
      fontSize: 10, color: colors.gray, align: 'center', margin: 0
    });

    cardX += 2.25;
  });

  // Role Distribution Chart
  slide.addText('Role Distribution', {
    x: 0.5, y: 2.1, w: 9, h: 0.22,
    fontSize: 12, bold: true, color: colors.navy, margin: 0
  });

  const roleCounts = ieGetRoleCounts();
  const totalRoles = Object.values(roleCounts).reduce((a, b) => a + b, 0);
  const roleColors = {
    Executive: '2e8540',
    Operational: 'F9A13A',
    Technical: '006462',
    Regional: '1a73b5'
  };

  let roleY = 2.38;
  Object.entries(roleCounts).forEach(([role, count]) => {
    const pct = totalRoles > 0 ? Math.round((count / totalRoles) * 100) : 0;
    const barWidth = (pct / 100) * 3.5;

    slide.addText(role, {
      x: 0.5, y: roleY, w: 1.3, h: 0.22,
      fontSize: 10, color: colors.navy, margin: 0
    });

    slide.addShape("rect", {
      x: 1.9, y: roleY + 0.04, w: 3.5, h: 0.15,
      fill: { color: 'E0D8CE' }, line: { type: 'none' }, margin: 0
    });

    slide.addShape("rect", {
      x: 1.9, y: roleY + 0.04, w: barWidth, h: 0.15,
      fill: { color: roleColors[role] }, line: { type: 'none' }, margin: 0
    });

    slide.addText(`${count} (${pct}%)`, {
      x: 5.6, y: roleY, w: 1, h: 0.22,
      fontSize: 10, bold: true, color: colors.navy, margin: 0
    });

    roleY += 0.32;
  });

  // Key Insight
  slide.addShape("rect", {
    x: 0.5, y: 3.8, w: 9, h: 0.9,
    fill: { color: colors.blueBg }, line: { color: colors.blue, width: 1 }, margin: 0
  });

  slide.addText('Pre-Session Insight', {
    x: 0.65, y: 3.85, w: 8.7, h: 0.16,
    fontSize: 10, bold: true, color: colors.blue, margin: 0
  });

  slide.addText(ieGenerateInsightText(), {
    x: 0.65, y: 4.03, w: 8.7, h: 0.62,
    fontSize: 10, color: colors.text, valign: 'top', margin: 0
  });

  ieSlideFooter(slide, slideNum);
  slideNum++;

  // SLIDE 4: Pre-Workshop Risk Dashboard
  slide = pres.addSlide();
  slide.background = { color: colors.white };
  ieSlideTopBar(slide);

  slide.addText('Pre-Workshop Risk Dashboard', {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 32, fontFace: 'Georgia', bold: true, color: colors.navy, margin: 0
  });

  const topRisks = ieGetTopRisks(4);
  const riskColors = {
    Critical: 'c73e1d',
    High: 'E8911A',
    Medium: 'c07600',
    Low: '8a7e6e'
  };

  let riskY = 0.65;
  topRisks.forEach((risk, idx) => {
    // Risk card background
    slide.addShape("rect", {
      x: 0.5, y: riskY, w: 9, h: 0.75,
      fill: { color: colors.offWhite }, line: { color: colors.lightGray, width: 1 }, margin: 0
    });

    // Category & Severity badges
    slide.addShape("rect", {
      x: 0.65, y: riskY + 0.08, w: 0.9, h: 0.18,
      fill: { color: 'F0F0F0' }, line: { type: 'none' }, margin: 0
    });
    slide.addText(risk.category || 'Risk', {
      x: 0.65, y: riskY + 0.08, w: 0.9, h: 0.18,
      fontSize: 8, bold: true, color: colors.text, align: 'center', valign: 'middle', margin: 0
    });

    slide.addShape("rect", {
      x: 1.65, y: riskY + 0.08, w: 0.75, h: 0.18,
      fill: { color: riskColors[risk.severity] }, line: { type: 'none' }, margin: 0
    });
    slide.addText(risk.severity || 'High', {
      x: 1.65, y: riskY + 0.08, w: 0.75, h: 0.18,
      fontSize: 8, bold: true, color: 'FFFFFF', align: 'center', valign: 'middle', margin: 0
    });

    // Risk title & description
    slide.addText(risk.title || `Risk ${idx + 1}`, {
      x: 2.5, y: riskY + 0.06, w: 6.8, h: 0.18,
      fontSize: 11, bold: true, color: colors.text, margin: 0
    });

    slide.addText(risk.description || 'Detailed risk assessment needed.', {
      x: 2.5, y: riskY + 0.27, w: 6.8, h: 0.4,
      fontSize: 9, color: colors.text, valign: 'top', margin: 0
    });

    riskY += 0.85;
  });

  slide.addText('Facilitator Note: Acknowledge risks upfront. Present mitigation strategies for each during decisions discussion.', {
    x: 0.5, y: 4.95, w: 9, h: 0.2,
    fontSize: 9, italic: true, color: colors.gray, margin: 0
  });

  ieSlideFooter(slide, slideNum);
  slideNum++;

  // SLIDE 5: Pre-Workshop Wins & Strong Alignment
  slide = pres.addSlide();
  slide.background = { color: colors.white };
  ieSlideTopBar(slide);

  slide.addText('Pre-Workshop Wins & Strong Alignment', {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 32, fontFace: 'Georgia', bold: true, color: colors.navy, margin: 0
  });

  const topWins = ieGetTopWins(3);

  let winY = 0.65;
  topWins.forEach((win, idx) => {
    slide.addShape("rect", {
      x: 0.5, y: winY, w: 9, h: 0.7,
      fill: { color: colors.greenBg }, line: { color: colors.green, width: 1 }, margin: 0
    });

    // Consensus badge
    slide.addShape("rect", {
      x: 0.65, y: winY + 0.08, w: 0.8, h: 0.22,
      fill: { color: colors.green }, line: { type: 'none' }, margin: 0
    });
    slide.addText(`${win.consensus}%`, {
      x: 0.65, y: winY + 0.08, w: 0.8, h: 0.22,
      fontSize: 11, bold: true, color: 'FFFFFF', align: 'center', valign: 'middle', margin: 0
    });

    // Decision title
    slide.addText(`D${win.id}: ${win.title}`, {
      x: 1.55, y: winY + 0.06, w: 7.7, h: 0.22,
      fontSize: 12, bold: true, color: colors.green, margin: 0
    });

    // Strategy note
    const strategyText = {
      1: 'Team alignment on roles is strong. Use this as foundation for other decisions.',
      3: 'Simple intake design has high support. Move quickly to prototype and validation.',
      7: 'Consensus on quarterly cadence allows focus on execution excellence.',
      6: 'Fatigue guardrails are non-negotiable. Position as risk mitigation.',
      5: 'Hybrid model consensus enables localization while maintaining control.',
      2: 'Process clarity is emerging. Validate with Technical stakeholders.',
      4: 'Rights decision requires role clarity from D1. Sequence accordingly.',
      8: 'Data quality consensus is low. Present phased approach to remediation.'
    };

    slide.addText(strategyText[win.id] || 'Strong team support. Build on this momentum.', {
      x: 1.55, y: winY + 0.32, w: 7.7, h: 0.3,
      fontSize: 9, color: colors.text, valign: 'top', margin: 0
    });

    winY += 0.8;
  });

  ieSlideFooter(slide, slideNum);
  slideNum++;

  // SLIDE 6: Per-Stakeholder Intelligence Summary
  slide = pres.addSlide();
  slide.background = { color: colors.white };
  ieSlideTopBar(slide);

  slide.addText('Per-Stakeholder Summary', {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 32, fontFace: 'Georgia', bold: true, color: colors.navy, margin: 0
  });

  const stakeholderData = ieGetStakeholderTable();

  // Table headers
  const headerY = 0.62;
  const headerColX = [0.5, 1.8, 2.8, 4.0, 7.0, 8.8];
  const headerLabels = ['Name', 'Role', 'Primary Concern', 'Alignment', 'Watch'];
  const colWidths = [1.2, 0.9, 2.8, 1.8, 0.7];

  headerLabels.forEach((label, idx) => {
    slide.addText(label, {
      x: headerColX[idx], y: headerY, w: colWidths[idx], h: 0.2,
      fontSize: 9, bold: true, color: colors.white, margin: 0,
      fill: colors.navy
    });
  });

  // Table rows
  let tableY = headerY + 0.25;
  stakeholderData.slice(0, 10).forEach((row, idx) => {
    const bgColor = idx % 2 === 0 ? colors.white : colors.offWhite;

    const alignmentColor = row.alignment === 'High' ? colors.green : row.alignment === 'Medium' ? colors.amber : colors.red;
    const alignmentBg = row.alignment === 'High' ? colors.greenBg : row.alignment === 'Medium' ? colors.amberBg : colors.redBg;

    slide.addShape("rect", {
      x: 0.5, y: tableY, w: 9, h: 0.2,
      fill: { color: bgColor }, line: { type: 'none' }, margin: 0
    });

    slide.addText(row.name, {
      x: 0.5, y: tableY, w: 1.2, h: 0.2,
      fontSize: 8, color: colors.text, valign: 'middle', margin: 0
    });

    slide.addText(row.role, {
      x: 1.8, y: tableY, w: 0.9, h: 0.2,
      fontSize: 8, color: colors.text, valign: 'middle', margin: 0
    });

    slide.addText(row.concern.substring(0, 40), {
      x: 2.8, y: tableY, w: 2.8, h: 0.2,
      fontSize: 8, color: colors.gray, valign: 'middle', margin: 0
    });

    slide.addShape("rect", {
      x: 7.0, y: tableY + 0.04, w: 1.6, h: 0.12,
      fill: { color: alignmentBg }, line: { type: 'none' }, margin: 0
    });

    slide.addText(row.alignment, {
      x: 7.0, y: tableY, w: 1.6, h: 0.2,
      fontSize: 8, bold: true, color: alignmentColor, align: 'center', valign: 'middle', margin: 0
    });

    slide.addText('', {
      x: 8.8, y: tableY, w: 0.7, h: 0.2,
      fontSize: 8, color: colors.text, align: 'center', valign: 'middle', margin: 0
    });

    tableY += 0.22;
  });

  ieSlideFooter(slide, slideNum);
  slideNum++;

  // ========== SECTION 3: SCOPE & EXPECTATIONS (Slides 7-9) ==========

  // SLIDE 7: Scope and Expectations Alignment
  slide = pres.addSlide();
  slide.background = { color: colors.white };
  ieSlideTopBar(slide);

  slide.addText('Scope and Expectations Alignment', {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 32, fontFace: 'Georgia', bold: true, color: colors.navy, margin: 0
  });

  slide.addText('Workshop Purpose', {
    x: 0.5, y: 0.65, w: 9, h: 0.22,
    fontSize: 12, bold: true, color: colors.navy, margin: 0
  });

  const purposeText = 'Establish governance framework, make 8 key decisions on roles/process/data, and design end-to-end CMX delivery model that balances centralized control with regional autonomy.';
  slide.addText(purposeText, {
    x: 0.5, y: 0.9, w: 9, h: 0.5,
    fontSize: 10, color: colors.text, margin: 0
  });

  slide.addText('Key Messages', {
    x: 0.5, y: 1.5, w: 9, h: 0.22,
    fontSize: 12, bold: true, color: colors.navy, margin: 0
  });

  const keyMessages = [
    'CMX is a centralized platform with decentralized governance guardrails.',
    'Decisions made today will enable scaled deployment across 14 regions.',
    'Strong stakeholder alignment on roles, process, and fatigue protection.',
    'Regional autonomy within global compliance and data quality frameworks.',
    'SMS + QR code access for field workers (non-email populations).',
    'Phased rollout: pilot region (FPL), then scaled delivery.'
  ];

  let msgY = 1.78;
  keyMessages.forEach(msg => {
    slide.addText(`‚Ä¢ ${msg}`, {
      x: 0.7, y: msgY, w: 8.8, h: 0.32,
      fontSize: 9, color: colors.text, margin: 0
    });
    msgY += 0.35;
  });

  ieSlideFooter(slide, slideNum);
  slideNum++;

  // SLIDE 8: Scope Continued
  slide = pres.addSlide();
  slide.background = { color: colors.white };
  ieSlideTopBar(slide);

  slide.addText('Scope: Dependencies & Assumptions', {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 32, fontFace: 'Georgia', bold: true, color: colors.navy, margin: 0
  });

  slide.addText('Critical Dependencies', {
    x: 0.5, y: 0.65, w: 4.3, h: 0.22,
    fontSize: 12, bold: true, color: colors.navy, margin: 0
  });

  const dependencies = [
    'Workday API access approval (Legal team)',
    'SMS vendor selection (Twilio vs MessageBird)',
    'Contact Directory cleanup & deduplication',
    'NERC CIP compliance classification',
    'Glint blackout calendar integration',
    'Regional lead readiness verification'
  ];

  let depY = 0.9;
  dependencies.forEach(dep => {
    slide.addText(`‚úì ${dep}`, {
      x: 0.7, y: depY, w: 4, h: 0.25,
      fontSize: 9, color: colors.text, margin: 0
    });
    depY += 0.28;
  });

  slide.addText('Key Assumptions', {
    x: 5.2, y: 0.65, w: 4.3, h: 0.22,
    fontSize: 12, bold: true, color: colors.navy, margin: 0
  });

  const assumptions = [
    'Regional leads can commit to pilot timeline',
    'Data quality issues will be resolved before go-live',
    'Hybrid governance model is acceptable to Sponsor',
    'Monthly pulse surveys fit resource constraints',
    'Field worker SMS is technically feasible',
    'Change management plan exists for all regions'
  ];

  let assY = 0.9;
  assumptions.forEach(ass => {
    slide.addText(`‚Üí ${ass}`, {
      x: 5.4, y: assY, w: 4, h: 0.25,
      fontSize: 9, color: colors.text, margin: 0
    });
    assY += 0.28;
  });

  ieSlideFooter(slide, slideNum);
  slideNum++;

  // SLIDE 9: High Level Delivery Timeline
  slide = pres.addSlide();
  slide.background = { color: colors.white };
  ieSlideTopBar(slide);

  slide.addText('High Level Delivery Timeline', {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 32, fontFace: 'Georgia', bold: true, color: colors.navy, margin: 0
  });

  const timeline = [
    { phase: 'WS1: Governance & Decisions', dates: 'March 12, 2026 (Today)', status: 'Current' },
    { phase: 'WS2: Stakeholder Mapping & Comms', dates: 'March 26-27, 2026 (+2 weeks)', status: 'Planned' },
    { phase: 'WS3: Survey Content & Design', dates: 'April 9-10, 2026 (+3 weeks)', status: 'Planned' },
    { phase: 'WS4: Platform & Metadata', dates: 'April 23-24, 2026 (+2 weeks)', status: 'Planned' },
    { phase: 'Build & Validation Phase', dates: 'May-June 2026 (+4 weeks)', status: 'Planned' },
    { phase: 'Pilot: FPL Region', dates: 'July 1, 2026 (+2 weeks)', status: 'Planned' },
    { phase: 'Scale: All Regions', dates: 'August-September 2026', status: 'Planned' }
  ];

  let tlY = 0.65;
  timeline.forEach((item, idx) => {
    const statusColor = item.status === 'Current' ? colors.orange : item.status === 'Planned' ? colors.blue : colors.green;
    const statusBg = item.status === 'Current' ? colors.amberBg : item.status === 'Planned' ? colors.blueBg : colors.greenBg;

    slide.addShape("rect", {
      x: 0.5, y: tlY, w: 9, h: 0.35,
      fill: { color: idx % 2 === 0 ? colors.white : colors.offWhite }, line: { color: colors.lightGray, width: 1 }, margin: 0
    });

    slide.addText(item.phase, {
      x: 0.65, y: tlY + 0.05, w: 5.2, h: 0.25,
      fontSize: 10, bold: true, color: colors.navy, margin: 0
    });

    slide.addText(item.dates, {
      x: 6.0, y: tlY + 0.05, w: 2.2, h: 0.25,
      fontSize: 9, color: colors.gray, margin: 0
    });

    slide.addShape("rect", {
      x: 8.4, y: tlY + 0.08, w: 1.0, h: 0.19,
      fill: { color: statusBg }, line: { type: 'none' }, margin: 0
    });

    slide.addText(item.status, {
      x: 8.4, y: tlY + 0.08, w: 1.0, h: 0.19,
      fontSize: 8, bold: true, color: statusColor, align: 'center', valign: 'middle', margin: 0
    });

    tlY += 0.4;
  });

  ieSlideFooter(slide, slideNum);
  slideNum++;

  // ========== SECTION 4: GOVERNANCE (Slides 10-17) ==========

  // SLIDE 10: Decision Governance
  slide = pres.addSlide();
  slide.background = { color: colors.white };
  ieSlideTopBar(slide);

  slide.addText('Decision Governance Framework', {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 32, fontFace: 'Georgia', bold: true, color: colors.navy, margin: 0
  });

  const decisionTypes = [
    { type: 'GLOBAL', desc: 'Uniform across all regions. No variation allowed.', examples: 'Fatigue limits, Data retention, NERC CIP scope', count: 2, color: colors.red, decCount: 6 },
    { type: 'SHARED', desc: 'Global templates + regional configuration.', examples: 'Intake form, Report templates, Escalation flows', count: 3, color: colors.amber, decCount: 7 },
    { type: 'LOCAL', desc: 'Regional autonomy within guardrails.', examples: 'Survey timing, Communication methods, Cadence', count: 3, color: colors.green, decCount: 8 }
  ];

  let decTypeY = 0.65;
  decisionTypes.forEach(dt => {
    slide.addShape("rect", {
      x: 0.5, y: decTypeY, w: 9, h: 0.9,
      fill: { color: colors.offWhite }, line: { color: colors.lightGray, width: 1 }, margin: 0
    });

    slide.addShape("rect", {
      x: 0.5, y: decTypeY, w: 0.15, h: 0.9,
      fill: { color: dt.color }, line: { type: 'none' }, margin: 0
    });

    slide.addText(dt.type, {
      x: 0.75, y: decTypeY + 0.05, w: 2.2, h: 0.2,
      fontSize: 12, bold: true, color: dt.color, margin: 0
    });

    slide.addText(dt.desc, {
      x: 0.75, y: decTypeY + 0.28, w: 8.5, h: 0.25,
      fontSize: 9, color: colors.text, margin: 0
    });

    slide.addText(`Examples: ${dt.examples}`, {
      x: 0.75, y: decTypeY + 0.56, w: 8.5, h: 0.28,
      fontSize: 9, italic: true, color: colors.gray, margin: 0
    });

    decTypeY += 1.05;
  });

  ieSlideFooter(slide, slideNum);
  slideNum++;

  // SLIDES 11-17: Individual Decision Deep-Dives
  for (let d = 0; d < 8; d++) {
    ieGenerateDecisionSlide(pres, d);
    slideNum++;
  }

  // ========== SECTION 5: PROCESS MAPPING (Slides 26-28) ==========

  // SLIDE 26: Process Mapping Objectives
  slide = pres.addSlide();
  slide.background = { color: colors.white };
  ieSlideTopBar(slide);

  slide.addText('Process Mapping Objectives', {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 32, fontFace: 'Georgia', bold: true, color: colors.navy, margin: 0
  });

  slide.addText('Nextera CMX E2E Process Context', {
    x: 0.5, y: 0.65, w: 9, h: 0.22,
    fontSize: 12, bold: true, color: colors.orange, margin: 0
  });

  const processContext = 'CMX enables survey-based insights collection from 14 regions (100,000+ employees, 60% field workers). Process must support intake from corporate office, distributed operations, and field sites with varied access (email, SMS, QR code, mobile app).';
  slide.addText(processContext, {
    x: 0.5, y: 0.9, w: 9, h: 0.5,
    fontSize: 10, color: colors.text, margin: 0
  });

  slide.addText('Key Design Goals', {
    x: 0.5, y: 1.5, w: 9, h: 0.22,
    fontSize: 12, bold: true, color: colors.navy, margin: 0
  });

  const designGoals = [
    'Intake should be simple (7 core fields) with optional metadata module for advanced use cases.',
    'Survey launch must support role-based targeting (Executive summary, Manager cascade, Field team SMS).',
    'Response collection accommodates email, web, SMS, QR code, and future mobile app channels.',
    'Data validation and enrichment happen before insights delivery (no raw data to stakeholders).',
    'Escalation paths are clear: data quality issues ‚Üí Data Steward, policy violations ‚Üí Compliance, business risks ‚Üí Sponsor.',
    'Regional variations are enabled through shared templates + localization (language, contact methods, timing).'
  ];

  let goalY = 1.78;
  designGoals.forEach(goal => {
    slide.addText(`‚úì ${goal}`, {
      x: 0.7, y: goalY, w: 8.8, h: 0.4,
      fontSize: 9, color: colors.text, margin: 0
    });
    goalY += 0.42;
  });

  ieSlideFooter(slide, slideNum);
  slideNum++;

  // SLIDE 27: Key Design Elements
  slide = pres.addSlide();
  slide.background = { color: colors.white };
  ieSlideTopBar(slide);

  slide.addText('Key Process Design Elements', {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 32, fontFace: 'Georgia', bold: true, color: colors.navy, margin: 0
  });

  const designElements = [
    {
      heading: 'UX Roles & Access',
      content: 'Intake authors (corporate), Survey managers (regional), Response monitors (teams), Insights consumers (leadership). Role-based dashboards with read-only access for non-owners.'
    },
    {
      heading: 'Tagging & Routing Rules',
      content: 'Auto-route based on escalation type (Blocker ‚Üí Data Steward, Risk ‚Üí Compliance, Opportunity ‚Üí Sponsor). Tag surveys by region, department, initiative.'
    },
    {
      heading: 'Intake Touch Points',
      content: 'Email request form, self-service portal, Slack integration (future). All requests captured in single intake queue for prioritization.'
    },
    {
      heading: 'Governance Touchpoints',
      content: 'Fatigue check: max 1 survey per employee per quarter. Conflict review: overlapping initiatives flagged. Compliance check: NERC CIP classification before launch.'
    }
  ];

  let elemY = 0.65;
  designElements.forEach((elem, idx) => {
    const bgColor = idx % 2 === 0 ? colors.offWhite : colors.white;

    slide.addShape("rect", {
      x: 0.5, y: elemY, w: 9, h: 0.8,
      fill: { color: bgColor }, line: { color: colors.lightGray, width: 1 }, margin: 0
    });

    slide.addText(elem.heading, {
      x: 0.65, y: elemY + 0.06, w: 8.7, h: 0.2,
      fontSize: 11, bold: true, color: colors.orange, margin: 0
    });

    slide.addText(elem.content, {
      x: 0.65, y: elemY + 0.28, w: 8.7, h: 0.45,
      fontSize: 9, color: colors.text, valign: 'top', margin: 0
    });

    elemY += 0.88;
  });

  ieSlideFooter(slide, slideNum);
  slideNum++;

  // SLIDE 28: General Workflow
  slide = pres.addSlide();
  slide.background = { color: colors.white };
  ieSlideTopBar(slide);

  slide.addText('E2E Workflow & Swim Lanes', {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 32, fontFace: 'Georgia', bold: true, color: colors.navy, margin: 0
  });

  // Swim lane setup
  const swimLanes = ['Requester', 'Survey Manager', 'Technical (Platform)', 'Data Steward', 'Sponsor (Escalations)'];
  const swimLaneY = [0.65, 1.3, 1.95, 2.6, 3.25];
  const laneX = 0.5;
  const laneW = 1.4;

  swimLanes.forEach((lane, idx) => {
    slide.addShape("rect", {
      x: laneX, y: swimLaneY[idx], w: laneW, h: 0.58,
      fill: { color: colors.offWhite }, line: { color: colors.lightGray, width: 1 }, margin: 0
    });

    slide.addText(lane, {
      x: laneX, y: swimLaneY[idx] + 0.15, w: laneW, h: 0.28,
      fontSize: 9, bold: true, color: colors.navy, align: 'center', valign: 'middle', margin: 0
    });
  });

  // Process steps
  const steps = [
    { lane: 0, title: 'Submit Intake Request', x: 2.1 },
    { lane: 1, title: 'Validate Fatigue/Conflicts', x: 3.6 },
    { lane: 2, title: 'Configure Survey', x: 5.1 },
    { lane: 3, title: 'QA Data Fields', x: 6.6 },
    { lane: 0, title: 'Approve Launch', x: 8.1 },
    { lane: 1, title: 'Send to Respondents', x: 9.6 },
  ];

  steps.forEach((step, idx) => {
    const yCenter = swimLaneY[step.lane] + 0.29;
    slide.addShape("rect", {
      x: step.x, y: yCenter - 0.12, w: 1.3, h: 0.24,
      fill: { color: colors.blue }, line: { type: 'none' }, margin: 0
    });

    slide.addText(step.title, {
      x: step.x, y: yCenter - 0.12, w: 1.3, h: 0.24,
      fontSize: 7, bold: true, color: 'FFFFFF', align: 'center', valign: 'middle', margin: 0
    });

    if (idx < steps.length - 1) {
      const nextStep = steps[idx + 1];
      const nextX = nextStep.x;
      const currentX = step.x + 1.3;
      slide.addShape("line", {
        x: currentX, y: yCenter, w: nextX - currentX, h: 0,
        line: { color: colors.gray, width: 1 }, margin: 0
      });
    }
  });

  // Legend
  slide.addText('Response Collection: Email, Web, SMS/QR (Field) ‚Üí Data Validation ‚Üí Insights Delivery', {
    x: 0.5, y: 4.5, w: 9, h: 0.35,
    fontSize: 9, italic: true, color: colors.gray, margin: 0
  });

  ieSlideFooter(slide, slideNum);
  slideNum++;

  // ========== SECTION 6: CASCADE & NEXT STEPS (Slides 29-31) ==========

  // SLIDE 29: Cascade Preview
  slide = pres.addSlide();
  slide.background = { color: colors.white };
  ieSlideTopBar(slide);

  slide.addText('Cascade Preview: WS2-WS4 Dependencies', {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 32, fontFace: 'Georgia', bold: true, color: colors.navy, margin: 0
  });

  const cascadeItems = [
    {
      ws: 'WS2: Stakeholder Mapping & Communications',
      input: 'Governance framework + decision outcomes from WS1',
      output: 'RACI matrix, escalation paths, communication plan, stakeholder personas',
      deps: 'D1 (Roles) + D4 (Rights) must be finalized'
    },
    {
      ws: 'WS3: Survey Content & Design',
      input: 'Governance model + intake decision from WS1',
      output: 'Survey question library, intake templates, response options, validation rules',
      deps: 'D2 (Process) + D3 (Intake) + D6 (Fatigue) must be decided'
    },
    {
      ws: 'WS4: Platform & Metadata Architecture',
      input: 'All 8 decisions + process map from WS1',
      output: 'Technical architecture, metadata schema, API spec, integration roadmap',
      deps: 'D5 (Governance Model) + D8 (Data Ownership) critical for scope'
    }
  ];

  let cascadeY = 0.65;
  cascadeItems.forEach((item, idx) => {
    const bgColor = idx % 2 === 0 ? colors.white : colors.offWhite;

    slide.addShape("rect", {
      x: 0.5, y: cascadeY, w: 9, h: 1.15,
      fill: { color: bgColor }, line: { color: colors.lightGray, width: 1 }, margin: 0
    });

    slide.addText(item.ws, {
      x: 0.65, y: cascadeY + 0.06, w: 8.7, h: 0.18,
      fontSize: 11, bold: true, color: colors.orange, margin: 0
    });

    slide.addText(`Input: ${item.input}`, {
      x: 0.65, y: cascadeY + 0.26, w: 8.7, h: 0.2,
      fontSize: 9, color: colors.text, margin: 0
    });

    slide.addText(`Output: ${item.output}`, {
      x: 0.65, y: cascadeY + 0.47, w: 8.7, h: 0.2,
      fontSize: 9, color: colors.text, margin: 0
    });

    slide.addText(`Dependencies: ${item.deps}`, {
      x: 0.65, y: cascadeY + 0.68, w: 8.7, h: 0.38,
      fontSize: 9, italic: true, color: colors.gray, margin: 0
    });

    cascadeY += 1.25;
  });

  ieSlideFooter(slide, slideNum);
  slideNum++;

  // SLIDE 30: Next Steps & Action Items
  slide = pres.addSlide();
  slide.background = { color: colors.white };
  ieSlideTopBar(slide);

  slide.addText('Next Steps & Action Items', {
    x: 0.5, y: 0.15, w: 9, h: 0.35,
    fontSize: 32, fontFace: 'Georgia', bold: true, color: colors.navy, margin: 0
  });

  const actionItems = STATE.analysis?.openPoints || [];
  const topActions = actionItems.slice(0, 8);

  slide.addText('Open Points to Resolve Before WS2', {
    x: 0.5, y: 0.65, w: 9, h: 0.22,
    fontSize: 12, bold: true, color: colors.navy, margin: 0
  });

  let actionY = 0.92;
  topActions.forEach((action, idx) => {
    const priorityColor = action.priority === 'High' ? colors.red : action.priority === 'Medium' ? colors.amber : colors.blue;

    slide.addShape("rect", {
      x: 0.5, y: actionY - 0.02, w: 0.08, h: 0.28,
      fill: { color: priorityColor }, line: { type: 'none' }, margin: 0
    });

    slide.addText(`OP-${idx + 1}`, {
      x: 0.65, y: actionY - 0.02, w: 0.5, h: 0.12,
      fontSize: 8, bold: true, color: colors.navy, margin: 0
    });

    slide.addText(action.category, {
      x: 1.25, y: actionY - 0.02, w: 1.2, h: 0.12,
      fontSize: 8, color: colors.gray, margin: 0
    });

    slide.addText(action.text, {
      x: 2.6, y: actionY - 0.02, w: 5, h: 0.28,
      fontSize: 9, color: colors.text, valign: 'top', margin: 0
    });

    slide.addText(`${action.owner}`, {
      x: 7.8, y: actionY + 0.06, w: 1.7, h: 0.16,
      fontSize: 8, bold: true, color: colors.orange, align: 'right', margin: 0
    });

    actionY += 0.35;
  });

  ieSlideFooter(slide, slideNum);
  slideNum++;

  // SLIDE 31: Closing Slide
  slide = pres.addSlide();
  slide.background = { color: colors.navy };
  ieSlideTopBar(slide);

  slide.addText('Thank You', {
    x: 0.5, y: 1.5, w: 9, h: 0.5,
    fontSize: 48, bold: true, fontFace: 'Georgia', color: colors.orange, align: 'center', margin: 0
  });

  slide.addText(`${clientName} | ${programName}`, {
    x: 0.5, y: 2.15, w: 9, h: 0.3,
    fontSize: 16, color: colors.cream, align: 'center', margin: 0
  });

  slide.addShape("rect", {
    x: 2.5, y: 2.6, w: 5, h: 0.015,
    fill: { color: colors.orange }, line: { type: 'none' }, margin: 0
  });

  slide.addText('Pre-populated with Intelligence Engine Analysis | AKT Global CMX Workshop 1', {
    x: 0.5, y: 2.85, w: 9, h: 0.3,
    fontSize: 11, italic: true, color: '999999', align: 'center', margin: 0
  });

  const fileName = `CMX-WS1-Deck-${clientName.split(' ')[0]}-${new Date().toISOString().split('T')[0]}.pptx`;
  pres.writeFile({ fileName: fileName }).then(() => {
    alert(`PPTX generated successfully: ${fileName}`);
  }).catch((err) => {
    console.error('PPTX generation error:', err);
    alert(`PPTX generation failed: ${err.message}`);
  });
}

function ieGenerateTracker() {
  const clientName = STATE.ieClientName || 'Client';
  const today = new Date().toISOString().split('T')[0];
  const fileName = `CMX-WS1-Tracker-${clientName}-${today}.xlsx`;

  const wb = XLSX.utils.book_new();

  const openPointsData = [
    { ID: 'OP-001', Category: 'Technical', Description: 'Workday API access approval pending', Owner: 'IT/Data Team', Priority: 'High', Status: 'Open' },
    { ID: 'OP-002', Category: 'Data', Description: 'Contact Directory quality issues', Owner: 'Data Steward', Priority: 'High', Status: 'Open' },
    { ID: 'OP-003', Category: 'Process', Description: 'SMS provider selection TBD', Owner: 'Project Manager', Priority: 'Medium', Status: 'Open' },
    { ID: 'OP-004', Category: 'Governance', Description: 'Escalation path definition needed', Owner: 'Sponsor', Priority: 'Medium', Status: 'Open' }
  ];

  let sheet = XLSX.utils.json_to_sheet(openPointsData);
  sheet['!cols'] = [
    { wch: 10 }, { wch: 14 }, { wch: 40 }, { wch: 15 }, { wch: 10 }, { wch: 10 }
  ];
  XLSX.utils.book_append_sheet(wb, sheet, 'Open Points');

  XLSX.writeFile(wb, fileName);
  alert(`XLSX generated: ${fileName}`);
}

function ieGenerateBriefing() {
  const clientName = STATE.ieClientName || 'Client';
  const today = new Date().toLocaleDateString();

  let html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CMX WS1 Briefing Pack</title>
  <style>
    body { font-family: Calibri, Arial, sans-serif; line-height: 1.6; color: #333; margin: 40px; }
    h1 { color: #2D2015; font-size: 2.5em; margin-bottom: 10px; }
    h2 { color: #2D2015; font-size: 1.8em; border-left: 4px solid #F9A13A; padding-left: 10px; margin-top: 30px; }
    .card { background: #FEF0DB; padding: 15px; border-left: 4px solid #F9A13A; margin: 15px 0; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th { background: #2D2015; color: white; padding: 12px; text-align: left; }
    td { padding: 12px; border-bottom: 1px solid #E0D8CE; }
    tr:nth-child(even) { background: #FEF0DB; }
  </style>
</head>
<body>
<h1>CMX WS1 Briefing Pack</h1>
<p><strong>Client:</strong> ${clientName}</p>
<p><strong>Date:</strong> ${today}</p>
<p><strong>Prepared by:</strong> AKT Global ‚Äî CMX Intelligence Engine</p>

<h2>Executive Summary</h2>
<p>This engagement is approaching Workshop 1 with the intelligence extracted from stakeholder interviews and survey responses.
Key readiness metrics, decision consensus scores, role divergence analysis, and risk signals are outlined below to guide facilitation strategy.</p>

<div class="card">
  <strong>Overall Readiness:</strong> ${STATE.ieAnalysis ? STATE.ieAnalysis.overallReadiness : 68}%<br/>
  <strong>Average Consensus:</strong> ${STATE.ieAnalysis ? STATE.ieAnalysis.avgConsensus : 72}%<br/>
  <strong>Key Risks Identified:</strong> ${STATE.ieAnalysis ? STATE.ieAnalysis.riskCount : 4}<br/>
  <strong>Open Points:</strong> ${STATE.ieAnalysis ? STATE.ieAnalysis.openPointCount : 9}
</div>

<h2>8 Governance Decisions</h2>
<table>
  <tr>
    <th>Decision #</th>
    <th>Title</th>
    <th>Consensus</th>
    <th>Key Challenge</th>
  </tr>
  <tr>
    <td>D1</td>
    <td>Roles & Responsibilities</td>
    <td>75%</td>
    <td>Role boundary clarity needed</td>
  </tr>
  <tr>
    <td>D2</td>
    <td>E2E Survey Process</td>
    <td>68%</td>
    <td>Process maturity variation across regions</td>
  </tr>
  <tr>
    <td>D3</td>
    <td>Intake Form Design</td>
    <td>72%</td>
    <td>Balance simplicity vs. metadata requirements</td>
  </tr>
  <tr>
    <td>D4</td>
    <td>Global vs Regional Rights</td>
    <td>65%</td>
    <td>Hub & spoke tension between exec and regional leads</td>
  </tr>
  <tr>
    <td>D5</td>
    <td>Governance Model</td>
    <td>70%</td>
    <td>Hybrid model adoption and accountability</td>
  </tr>
  <tr>
    <td>D6</td>
    <td>Fatigue Guardrails</td>
    <td>71%</td>
    <td>Contact frequency limits and competing surveys</td>
  </tr>
  <tr>
    <td>D7</td>
    <td>Operating Cadence</td>
    <td>74%</td>
    <td>Monthly vs quarterly rhythm preference</td>
  </tr>
  <tr>
    <td>D8</td>
    <td>Data Ownership & Quality</td>
    <td>62%</td>
    <td>HRIS integration and metadata quality</td>
  </tr>
</table>

<h2>Risk Register (Top Risks)</h2>
<div class="card">
  <strong>Capacity Risk:</strong> Overall program readiness below 70%. Teams may struggle with implementation pace.<br><br>
  <strong>Alignment Risk:</strong> Strong decentralization preference conflicts with governance model. Tech-Regional divergence high (55% alignment).<br><br>
  <strong>Adoption Risk:</strong> Field worker accessibility critical. SMS/QR code approach essential for large non-email populations.<br><br>
  <strong>Data Risk:</strong> Data governance concerns, NERC CIP compliance, and metadata quality issues flagged as critical path blockers.
</div>

<h2>Facilitator Recommendations</h2>
<ul>
  <li>Start with data readiness briefing to demonstrate AKT homework</li>
  <li>Use decision tree framework for efficient decision-making</li>
  <li>Plan Tech-Regional breakout session before Day 2 to resolve alignment gaps</li>
  <li>Acknowledge regional context and cultural considerations</li>
  <li>Time-box each decision: 15 min (quick consensus) to 45 min (contentious)</li>
</ul>

<p style="margin-top: 40px; color: #999; font-size: 0.9em;">
AKT Global | CMX Intelligence Engine | Confidential ‚Äî For Workshop Participants Only
</p>
</body>
</html>`;

  const briefingWindow = window.open('about:blank', '_blank');
  briefingWindow.document.write(html);
  briefingWindow.document.close();
  alert('Briefing pack opened in new window');
}

function ieGenerateAll() {
  alert('Generating all 3 artifacts...');
  ieGenerateDeck();
  setTimeout(() => ieGenerateTracker(), 500);
  setTimeout(() => ieGenerateBriefing(), 1000);
}

// ============================================================================
// COMMAND CENTER: PPTX GENERATION (WS1 DECK)
// ============================================================================

function generateDeckWS1() {
  const pres = new PptxGenJS();
  pres.defineLayout({ name: 'LAYOUT_16x9', width: 10, height: 5.625 });
  pres.layout = 'LAYOUT_16x9';

  const colors = {
    navy: '2D2015',
    orange: 'F9A13A',
    cream: 'FEF0DB',
    white: 'FFFFFF',
    gray: '737373',
    ok: '468A4B',
    error: 'CC3300'
  };

  // Slide 1: Title
  let slide = pres.addSlide();
  slide.background = { color: colors.navy };

  slide.addShape("rect", {
    x: 0, y: 0, w: 0.08, h: 5.625,
    fill: { color: colors.orange },
    line: { type: 'none' }
  });

  slide.addText('akt', {
    x: 0.5, y: 1.5, w: 3, h: 0.6,
    fontSize: 52, bold: true, fontFace: 'Arial Black',
    color: colors.orange
  });

  slide.addText('CMX Foundations Workshop 1', {
    x: 0.5, y: 2.2, w: 8, h: 0.5,
    fontSize: 40, fontFace: 'Georgia', bold: true,
    color: colors.white
  });

  slide.addText('Process Design & Governance', {
    x: 0.5, y: 2.75, w: 8, h: 0.4,
    fontSize: 22, fontFace: 'Georgia',
    color: colors.cream
  });

  slide.addText('Nextera Energy ‚Äî GMTP', {
    x: 0.5, y: 3.3, w: 8, h: 0.3,
    fontSize: 13, color: '999999'
  });

  slide.addShape("rect", {
    x: 0.5, y: 3.7, w: 8, h: 0.02,
    fill: { color: colors.orange },
    line: { type: 'none' }
  });

  slide.addText('March 12, 2026 | Pre-populated with stakeholder intelligence', {
    x: 0.5, y: 4, w: 8, h: 0.3,
    fontSize: 11, italic: true, color: '999999'
  });

  slide.addShape("rect", {
    x: 0, y: 5.465, w: 10, h: 0.16,
    fill: { color: colors.orange },
    line: { type: 'none' }
  });

  // Slide 2: Stakeholder Overview
  slide = pres.addSlide();
  slide.background = { color: colors.white };

  slide.addText('Stakeholder Intelligence Overview', {
    x: 0.5, y: 0.3, w: 9, h: 0.4,
    fontSize: 30, fontFace: 'Georgia', bold: true,
    color: colors.navy
  });

  const cardsData = [
    { val: '68%', lbl: 'Overall Readiness', color: 'D97706' },
    { val: '72%', lbl: 'Avg Consensus', color: colors.ok },
    { val: '4', lbl: 'Risk Signals', color: colors.error },
    { val: '9', lbl: 'Open Points', color: '3366CC' }
  ];

  let xPos = 0.5;
  cardsData.forEach(card => {
    slide.addShape("rect", {
      x: xPos, y: 1, w: 2, h: 1.2,
      fill: { color: colors.white },
      line: { color: 'E0D8CE', width: 1 }
    });

    slide.addText(card.val, {
      x: xPos, y: 1.15, w: 2, h: 0.5,
      fontSize: 36, bold: true,
      color: card.color,
      align: 'center'
    });

    slide.addText(card.lbl, {
      x: xPos, y: 1.75, w: 2, h: 0.4,
      fontSize: 11, color: colors.gray,
      align: 'center'
    });

    xPos += 2.1;
  });

  slide.addText('Role Distribution', {
    x: 0.5, y: 2.4, w: 9, h: 0.3,
    fontSize: 13, bold: true,
    color: colors.navy
  });

  const roleData = [
    { name: 'Executive', count: 2, color: colors.ok },
    { name: 'Operational', count: 4, color: colors.orange },
    { name: 'Technical', count: 3, color: '006462' },
    { name: 'Regional', count: 3, color: '3366CC' }
  ];

  let yPos = 2.8;
  roleData.forEach(role => {
    const pct = (role.count / 12) * 100;
    const barWidth = (pct / 100) * 2;

    slide.addText(role.name, {
      x: 0.5, y: yPos, w: 1.5, h: 0.25,
      fontSize: 11, color: colors.navy
    });

    slide.addShape("rect", {
      x: 2.1, y: yPos + 0.05, w: 2, h: 0.15,
      fill: { color: 'E0E0E0' },
      line: { type: 'none' }
    });

    slide.addShape("rect", {
      x: 2.1, y: yPos + 0.05, w: barWidth, h: 0.15,
      fill: { color: role.color },
      line: { type: 'none' }
    });

    slide.addText(`${role.count} (${Math.round(pct)}%)`, {
      x: 4.3, y: yPos, w: 1, h: 0.25,
      fontSize: 10, bold: true,
      color: colors.navy
    });

    yPos += 0.4;
  });

  // Save presentation
  const fileName = `CMX-WS1-Deck-Nextera-${new Date().toISOString().split('T')[0]}.pptx`;
  pres.writeFile({ fileName: fileName }).then(() => {
    alert(`PPTX generated: ${fileName}`);
  }).catch((err) => {
    console.error('PPTX writeFile error:', err);
    alert(`PPTX save failed: ${err.message}`);
  });
}

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
  STATE.responses = DEMO_DATA;
  runAnalysis();
  updateUI();

  // Setup drag-drop for Intelligence Engine
  const dropZone = document.getElementById('ieDropZone');
  if (dropZone) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.add('ie-over');
      });
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.remove('ie-over');
      });
    });

    dropZone.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length > 0) {
        const fileInput = document.getElementById('ieCsvFile');
        fileInput.files = files;
        ieHandleFile({ target: { files } });
      }
    });
  }
});
</script>

</body>
</html>
